<?php
bolt_decrypt( __FILE__ , 'KLYKXm'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcTXlhY2NvdW50aW5nXEludGVncmF0aW9uOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIEFwcCwgREIsIERhdGFUYWJsZXM7Cgp1c2UgXEFwcFxNb2RlbHNcUG1zTW9kZWxzXEFjY291bnRzXENoYXJ0T2ZBY2NvdW50Owp1c2UgXEFwcFxNb2RlbHNcSW50ZWdyYXRpb25cU291cmNlOwp1c2UgXEFwcFxNb2RlbHNcSW50ZWdyYXRpb25cQ29udHJvbFBvaW50Owp1c2UgXEFwcFxNb2RlbHNcSW50ZWdyYXRpb25cRW50cnlQb2ludDsKdXNlIFxBcHBcTW9kZWxzXEludGVncmF0aW9uXFJlcXVpcmVtZW50Owp1c2UgXEFwcFxNb2RlbHNcSW50ZWdyYXRpb25cUHJvY2VzczsKdXNlIFxBcHBcTW9kZWxzXEludGVncmF0aW9uXFN1YlByb2Nlc3M7CnVzZSBcQXBwXE1vZGVsc1xJbnRlZ3JhdGlvblxTdWJQcm9jZXNzTGVkZ2VyOwp1c2UgXEFwcFxNb2RlbHNcSW50ZWdyYXRpb25cRW50cnlQb2ludExlZGdlcjsKCmNsYXNzIFN1YlByb2Nlc3NDb250cm9sbGVyIGV4dGVuZHMgQ29udHJvbGxlcgp7CgogICAgLyoqCiAgICAgKiBTZXQgZ2xvYmFsIGRhdGEgdGFibGUgaGVhZGVycy4KICAgICAqCiAgICAgKiBAcmV0dXJuIGhlYWRlckNvbHVtbnMKICAgICAqLwogICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZT0nJykKICAgICB7CiAgICAgICAgcmV0dXJuIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsnY29kZScsICdjb2RlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnbmFtZScsICduYW1lJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsndHlwZScsICd0eXBlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc291cmNlJywgJ3NvdXJjZSddLAogICAgICAgICAgICBbJ2NvbnRyb2xfcG9pbnQnLCAnY29udHJvbF9wb2ludCddLAogICAgICAgICAgICBbJ2VudHJ5X3BvaW50JywgJ2VudHJ5X3BvaW50J10sCiAgICAgICAgICAgIFsncmVxdWlyZW1lbnQnLCAncmVxdWlyZW1lbnQnXSwKICAgICAgICAgICAgWydkZXNjcmlwdGlvbicsICdkZXNjcmlwdGlvbiddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGluZGV4KCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigKICAgICAgICAgICAgICAgICAgICBTdWJQcm9jZXNzOjp3aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzb3VyY2UnLCBmdW5jdGlvbiAoJHN1YlByb2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN1YlByb2Nlc3MtPnNvdXJjZS0+bmFtZTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc291cmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnc291cmNlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc291cmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgU291cmNlOjpzZWxlY3QoJ3NvdXJjZXMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3NvdXJjZXMuaWQnLCAnc3ViX3Byb2Nlc3Nlcy5zb3VyY2VfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignY29udHJvbF9wb2ludCcsIGZ1bmN0aW9uICgkc3ViUHJvY2VzcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkc3ViUHJvY2Vzcy0+Y29udHJvbFBvaW50LT5uYW1lOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdjb250cm9sX3BvaW50JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnY29udHJvbFBvaW50JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignY29udHJvbF9wb2ludCcsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIENvbnRyb2xQb2ludDo6c2VsZWN0KCdjb250cm9sX3BvaW50cy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignY29udHJvbF9wb2ludHMuaWQnLCAnc3ViX3Byb2Nlc3Nlcy5jb250cm9sX29pbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZW50cnlfcG9pbnQnLCBmdW5jdGlvbiAoJHN1YlByb2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN1YlByb2Nlc3MtPmVudHJ5UG9pbnQtPm5hbWU7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2VudHJ5X3BvaW50JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnZW50cnlQb2ludCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2VudHJ5X3BvaW50JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgRW50cnlQb2ludDo6c2VsZWN0KCdlbnRyeV9wb2ludHMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ2VudHJ5X3BvaW50cy5pZCcsICdzdWJfcHJvY2Vzc2VzLmVudHJ5X29pbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlyZW1lbnQnLCBmdW5jdGlvbiAoJHN1YlByb2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN1YlByb2Nlc3MtPnJlcXVpcmVtZW50LT5uYW1lOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXJlbWVudCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlcXVpcmVtZW50JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlyZW1lbnQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1aXJlbWVudDo6c2VsZWN0KCdyZXF1aXJlbWVudHMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVpcmVtZW50cy5pZCcsICdzdWJfcHJvY2Vzc2VzLnJlcXVpcmVtZW50X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbigkcHJvY2Vzcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tcHJpbWFyeSBtbC0xIiBocmVmPSInLnVybCgnYWNjb3VudGluZy9zdWItcHJvY2Vzc2VzLycuJHByb2Nlc3MtPmlkLicvZWRpdCcpLiciPjxpIGNsYXNzPSJsYSBsYS1lZGl0Ij48L2k+PC9hPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1kYW5nZXIgbWwtMSIgb25jbGljaz0iZGVsZXRlRnJvbUNSVUQoJCh0aGlzKSkiIGRhdGEtc3JjPSInLiByb3V0ZSgnYWNjb3VudGluZy5zdWItcHJvY2Vzc2VzLmRlc3Ryb3knLCAkcHJvY2Vzcy0+aWQpLiciPjxpIGNsYXNzPSJsYSBsYS10cmFzaCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdMaXN0IG9mIFByb2Nlc3NlcycsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmhlYWRlckNvbHVtbnMoKSwKICAgICAgICAgICAgXTsKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ2FjY291bnRpbmcuYmFja2VuZC5wYWdlcy5pbnRlZ3JhdGlvbnMuc3ViLXByb2Nlc3Nlcy5pbmRleCcsICRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGNyZWF0ZSgpCiAgICB7CiAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICd0aXRsZScgPT4gJ05ldyBTdWItUHJvY2VzcycsCiAgICAgICAgICAgICdzb3VyY2VzJyA9PiBTb3VyY2U6OmFsbCgpLAogICAgICAgICAgICAnY29udHJvbFBvaW50cycgPT4gQ29udHJvbFBvaW50OjphbGwoKSwKICAgICAgICAgICAgJ2VudHJ5UG9pbnRzJyA9PiBFbnRyeVBvaW50OjphbGwoKSwKICAgICAgICAgICAgJ3JlcXVpcmVtZW50cycgPT4gUmVxdWlyZW1lbnQ6OmFsbCgpLAogICAgICAgICAgICAncHJvY2Vzc2VzJyA9PiBQcm9jZXNzOjphbGwoKSwKICAgICAgICAgICAgJ2NvZGUnID0+IHVuaXF1ZUNvZGVXaXRob3V0UHJlZml4KDMsJ3N1Yl9wcm9jZXNzZXMnLCdjb2RlJykKICAgICAgICBdOwoKICAgICAgICByZXR1cm4gdmlldygnYWNjb3VudGluZy5iYWNrZW5kLnBhZ2VzLmludGVncmF0aW9ucy5zdWItcHJvY2Vzc2VzLmNyZWF0ZScsICRkYXRhKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc3RvcmUoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVxdWVzdC0+dmFsaWRhdGUoWwogICAgICAgICAgICAnY29kZScgPT4gJ3JlcXVpcmVkfHVuaXF1ZTpzdWJfcHJvY2Vzc2VzJywKICAgICAgICAgICAgJ25hbWUnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwcm9jZXNzX2lkJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAndHlwZScgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAnc291cmNlX2lkJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAnY29udHJvbF9wb2ludF9pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2VudHJ5X3BvaW50X2lkJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncmVxdWlyZW1lbnRfaWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgXSk7CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5ewogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+ZGViaXRfcGVyY2VudGFnZXMpICYmIGFycmF5X3N1bSgkcmVxdWVzdC0+ZGViaXRfcGVyY2VudGFnZXMpID4gMTAwKXsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigiVG90YWwgRGViaXQgUGVyY2VudGFnZXMgY2Fubm90IGJlIG1vcmUgdGhhbiAxMDAlIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5jcmVkaXRfcGVyY2VudGFnZXMpICYmIGFycmF5X3N1bSgkcmVxdWVzdC0+Y3JlZGl0X3BlcmNlbnRhZ2VzKSA+IDEwMCl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoIlRvdGFsIENyZWRpdCBQZXJjZW50YWdlcyBjYW5ub3QgYmUgbW9yZSB0aGFuIDEwMCUiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgCiAgICAgICAgICAgICRzdWJQcm9jZXNzID0gU3ViUHJvY2Vzczo6Y3JlYXRlKCRyZXF1ZXN0LT5hbGwoKSk7CgogICAgICAgICAgICAkbGVkZ2VycyA9IFtdOwogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+ZGViaXRfcGVyY2VudGFnZXMpICYmIGlzX2FycmF5KCRyZXF1ZXN0LT5kZWJpdF9wZXJjZW50YWdlcykgJiYgY291bnQoJHJlcXVlc3QtPmRlYml0X3BlcmNlbnRhZ2VzKSA+IDApewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPmRlYml0X3BlcmNlbnRhZ2VzIGFzICRjaGFydF9vZl9hY2NvdW50X2lkID0+ICRwZXJjZW50YWdlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkbGVkZ2VycywgWwogICAgICAgICAgICAgICAgICAgICAgICAnc3ViX3Byb2Nlc3NfaWQnID0+ICRzdWJQcm9jZXNzLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NoYXJ0X29mX2FjY291bnRfaWQnID0+ICRjaGFydF9vZl9hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ0QnLAogICAgICAgICAgICAgICAgICAgICAgICAncGVyY2VudGFnZScgPT4gJHBlcmNlbnRhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5jcmVkaXRfcGVyY2VudGFnZXMpICYmIGlzX2FycmF5KCRyZXF1ZXN0LT5jcmVkaXRfcGVyY2VudGFnZXMpICYmIGNvdW50KCRyZXF1ZXN0LT5jcmVkaXRfcGVyY2VudGFnZXMpID4gMCl7CiAgICAgICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+Y3JlZGl0X3BlcmNlbnRhZ2VzIGFzICRjaGFydF9vZl9hY2NvdW50X2lkID0+ICRwZXJjZW50YWdlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkbGVkZ2VycywgWwogICAgICAgICAgICAgICAgICAgICAgICAnc3ViX3Byb2Nlc3NfaWQnID0+ICRzdWJQcm9jZXNzLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NoYXJ0X29mX2FjY291bnRfaWQnID0+ICRjaGFydF9vZl9hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ0MnLAogICAgICAgICAgICAgICAgICAgICAgICAncGVyY2VudGFnZScgPT4gJHBlcmNlbnRhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGlzc2V0KCRsZWRnZXJzWzBdKSl7CiAgICAgICAgICAgICAgICBTdWJQcm9jZXNzTGVkZ2VyOjppbnNlcnQoJGxlZGdlcnMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoIlN1Yi1Qcm9jZXNzIGhhcyBiZWVuIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IiwgJ2FjY291bnRpbmcuc3ViLXByb2Nlc3Nlcy5jcmVhdGUnKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93KCRlbnRyeV9wb2ludF9pZCkKICAgIHsKICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgJ2VudHJ5UG9pbnRMZWRnZXJzJyA9PiBFbnRyeVBvaW50TGVkZ2VyOjp3aXRoKFsKICAgICAgICAgICAgICAgICdjaGFydE9mQWNjb3VudCcKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZSgnZW50cnlfcG9pbnRfaWQnLCAkZW50cnlfcG9pbnRfaWQpCiAgICAgICAgICAgIC0+b3JkZXJCeSgndHlwZScsICdkZXNjJykKICAgICAgICAgICAgLT5nZXQoKSwgCiAgICAgICAgXTsKCiAgICAgICAgcmV0dXJuIHZpZXcoJ2FjY291bnRpbmcuYmFja2VuZC5wYWdlcy5pbnRlZ3JhdGlvbnMuc3ViLXByb2Nlc3Nlcy5sZWRnZXJzJywgJGRhdGEpOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBlZGl0KCRpZCkKICAgIHsKICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgJ3RpdGxlJyA9PiAnRWRpdCBTdWItUHJvY2VzcycsCiAgICAgICAgICAgICdzdWJQcm9jZXNzJyA9PiBTdWJQcm9jZXNzOjp3aXRoKFsKICAgICAgICAgICAgICAgICdsZWRnZXJzLmNoYXJ0T2ZBY2NvdW50JwogICAgICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpLAogICAgICAgICAgICAnc291cmNlcycgPT4gU291cmNlOjphbGwoKSwKICAgICAgICAgICAgJ2NvbnRyb2xQb2ludHMnID0+IENvbnRyb2xQb2ludDo6YWxsKCksCiAgICAgICAgICAgICdlbnRyeVBvaW50cycgPT4gRW50cnlQb2ludDo6YWxsKCksCiAgICAgICAgICAgICdyZXF1aXJlbWVudHMnID0+IFJlcXVpcmVtZW50OjphbGwoKSwKICAgICAgICAgICAgJ3Byb2Nlc3NlcycgPT4gUHJvY2Vzczo6YWxsKCksCiAgICAgICAgXTsKCiAgICAgICAgcmV0dXJuIHZpZXcoJ2FjY291bnRpbmcuYmFja2VuZC5wYWdlcy5pbnRlZ3JhdGlvbnMuc3ViLXByb2Nlc3Nlcy5lZGl0JywgJGRhdGEpOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiB1cGRhdGUoUmVxdWVzdCAkcmVxdWVzdCwgJGlkKQogICAgewogICAgICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgICAgICduYW1lJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncHJvY2Vzc19pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3R5cGUnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdkZXNjcmlwdGlvbicgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3NvdXJjZV9pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ2NvbnRyb2xfcG9pbnRfaWQnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdlbnRyeV9wb2ludF9pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3JlcXVpcmVtZW50X2lkJyA9PiAncmVxdWlyZWQnLAogICAgICAgIF0pOwoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeXsKICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPmRlYml0X3BlcmNlbnRhZ2VzKSAmJiBhcnJheV9zdW0oJHJlcXVlc3QtPmRlYml0X3BlcmNlbnRhZ2VzKSA+IDEwMCl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoIlRvdGFsIERlYml0IFBlcmNlbnRhZ2VzIGNhbm5vdCBiZSBtb3JlIHRoYW4gMTAwJSIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+Y3JlZGl0X3BlcmNlbnRhZ2VzKSAmJiBhcnJheV9zdW0oJHJlcXVlc3QtPmNyZWRpdF9wZXJjZW50YWdlcykgPiAxMDApewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCJUb3RhbCBDcmVkaXQgUGVyY2VudGFnZXMgY2Fubm90IGJlIG1vcmUgdGhhbiAxMDAlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICRzdWJQcm9jZXNzID0gU3ViUHJvY2Vzczo6ZmluZCgkaWQpOwogICAgICAgICAgICAkc3ViUHJvY2Vzcy0+ZmlsbCgkcmVxdWVzdC0+YWxsKCkpOwogICAgICAgICAgICAkc3ViUHJvY2Vzcy0+c2F2ZSgpOwoKICAgICAgICAgICAgU3ViUHJvY2Vzc0xlZGdlcjo6d2hlcmUoJ3N1Yl9wcm9jZXNzX2lkJywgJHN1YlByb2Nlc3MtPmlkKS0+ZGVsZXRlKCk7CgogICAgICAgICAgICAkbGVkZ2VycyA9IFtdOwogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+ZGViaXRfcGVyY2VudGFnZXMpICYmIGlzX2FycmF5KCRyZXF1ZXN0LT5kZWJpdF9wZXJjZW50YWdlcykgJiYgY291bnQoJHJlcXVlc3QtPmRlYml0X3BlcmNlbnRhZ2VzKSA+IDApewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPmRlYml0X3BlcmNlbnRhZ2VzIGFzICRjaGFydF9vZl9hY2NvdW50X2lkID0+ICRwZXJjZW50YWdlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkbGVkZ2VycywgWwogICAgICAgICAgICAgICAgICAgICAgICAnc3ViX3Byb2Nlc3NfaWQnID0+ICRzdWJQcm9jZXNzLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NoYXJ0X29mX2FjY291bnRfaWQnID0+ICRjaGFydF9vZl9hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ0QnLAogICAgICAgICAgICAgICAgICAgICAgICAncGVyY2VudGFnZScgPT4gJHBlcmNlbnRhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5jcmVkaXRfcGVyY2VudGFnZXMpICYmIGlzX2FycmF5KCRyZXF1ZXN0LT5jcmVkaXRfcGVyY2VudGFnZXMpICYmIGNvdW50KCRyZXF1ZXN0LT5jcmVkaXRfcGVyY2VudGFnZXMpID4gMCl7CiAgICAgICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+Y3JlZGl0X3BlcmNlbnRhZ2VzIGFzICRjaGFydF9vZl9hY2NvdW50X2lkID0+ICRwZXJjZW50YWdlKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkbGVkZ2VycywgWwogICAgICAgICAgICAgICAgICAgICAgICAnc3ViX3Byb2Nlc3NfaWQnID0+ICRzdWJQcm9jZXNzLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NoYXJ0X29mX2FjY291bnRfaWQnID0+ICRjaGFydF9vZl9hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ0MnLAogICAgICAgICAgICAgICAgICAgICAgICAncGVyY2VudGFnZScgPT4gJHBlcmNlbnRhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2J5JyA9PiBhdXRoKCktPnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGlzc2V0KCRsZWRnZXJzWzBdKSl7CiAgICAgICAgICAgICAgICBTdWJQcm9jZXNzTGVkZ2VyOjppbnNlcnQoJGxlZGdlcnMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoIlN1Yi1Qcm9jZXNzIGhhcyBiZWVuIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5IiwgJ2FjY291bnRpbmcuc3ViLXByb2Nlc3Nlcy5pbmRleCcpOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGRlc3Ryb3koJGlkKQogICAgewogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5ewogICAgICAgICAgICBTdWJQcm9jZXNzOjpmaW5kKCRpZCktPmRlbGV0ZSgpOwoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiU3ViLVByb2Nlc3MgaGFzIGJlZW4gRGVsZXRlZCEiCiAgICAgICAgICAgIF0pOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0KfQo=