<?php
bolt_decrypt( __FILE__ , 'uTv3W7'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7Cgp1c2UgQXBwXE1vZGVsc1xIclxEZXBhcnRtZW50Owp1c2UgQXBwXE1vZGVsc1xNeVByb2plY3RcRGVsaXZlcmFibGVzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcTWVudVxNZW51Owp1c2UgQXBwXE1vZGVsc1xIclxVbml0Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb25zOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25UcmFja2luZzsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uVHlwZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQ2F0ZWdvcnlEZXBhcnRtZW50Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcTm90aWZpY2F0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25EZWxpdmVyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25Ob3RlTG9nczsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xBY2NvdW50c1xDb21wYW55Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcQ29zdENlbnRyZTsKdXNlIEFwcFxNb2RlbHNcTXlQcm9qZWN0XFByb2plY3Q7CnVzZSBBcHBcTW9kZWxzXE15UHJvamVjdFxQcm9qZWN0VGFzazsKdXNlIElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0Owp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcVmlldzsKdXNlIEFwcFxIdHRwXFJlcXVlc3RzOwp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcQXV0aDsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXERCLCBJbGx1bWluYXRlXFN1cHBvcnRcRmFjYWRlc1xWYWxpZGF0b3IsIElsbHVtaW5hdGVcU3VwcG9ydFxTdHI7CnVzZSBDYXJib25cQ2FyYm9uOwp1c2UgWWFqcmFcRGF0YVRhYmxlc1xGYWNhZGVzXERhdGFUYWJsZXM7CgpjbGFzcyBSZXF1aXNpdGlvbkNvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsKCiAgICBwdWJsaWMgZnVuY3Rpb24gaGVhZGVyQ29sdW1ucygkdmFsdWUgPSAnJykKICAgIHsKICAgICAgICAkcm93ID0gYXJyYXkoCiAgICAgICAgICAgIFsnU0wnLCAnU0wnXSwKICAgICAgICAgICAgWydyZWZlcmVuY2Vfbm8nLCAncmVmZXJlbmNlX25vJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVxdWlzaXRpb25fZGF0ZScsICdyZXF1aXNpdGlvbl9kYXRlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncHJvZHVjdF9jYXRlZ29yeScsICdwcm9kdWN0X2NhdGVnb3J5JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3RhdHVzJywgJ3N0YXR1cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2F0dGFjaG1lbnQnLCAnYXR0YWNobWVudCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlcicsICd3aWR0aDoxNSUnXQogICAgICAgICk7CgogICAgICAgIGlmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSkgewoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bnNldCgkcm93WzVdKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcm93OwogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gaW5kZXgoKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkc3RhdHVzID0gcmVxdWVzdCgpLT5oYXMoJ3N0YXR1cycpID8gcmVxdWVzdCgpLT5nZXQoJ3N0YXR1cycpIDogLTE7CiAgICAgICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAgICAgJHRvID0gcmVxdWVzdCgpLT5oYXMoJ3RvJykgPyByZXF1ZXN0KCktPmdldCgndG8nKSA6IGRhdGUoJ1ktbS10Jyk7CiAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjYXRlZ29yeV9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2NhdGVnb3J5X2lkJykgOiAwOwogICAgICAgICAgICAkY2F0ZWdvcnlJZHMgPSBDYXRlZ29yeURlcGFydG1lbnQ6OndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfaWQnLCBhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9KS0+cGx1Y2soJ2NhdGVnb3J5X2lkJyktPnRvQXJyYXkoKTsKCiAgICAgICAgICAgICRjYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZHMpCiAgICAgICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyA9IFJlcXVpc2l0aW9uOjp3aXRoKFsnaXRlbXMnLCAnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeSddKQogICAgICAgICAgICAgICAgLT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkZnJvbSkgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRmcm9tKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJz49JywgJGZyb20pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJzw9JywgJHRvKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oJHN0YXR1cyA+PSAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJHN0YXR1cyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCRjYXRlZ29yeV9pZCA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5X2lkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZW1wdHkocmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScgLiByZXF1ZXN0KCktPmdldCgnc2VhcmNoX3RleHQnKSAuICclJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZSgncmVtYXJrcycsICdMSUtFJywgJyUnIC4gcmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykgLiAnJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlTm90SW4oJ3N0YXR1cycsIFsyXSk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkcmVxdWlzaXRpb25zKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0iYnRuIGJ0bi1saW5rIHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicgLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncmVxdWlzaXRpb25fZGF0ZScsICRvcmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRyZXF1aXNpdGlvbi0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSkgPyAkcmVxdWlzaXRpb24tPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1aXNpdGlvbkl0ZW06OnNlbGVjdCgnbWFpbl9jYXRlZ29yeS5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1aXNpdGlvbl9pdGVtcy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBzdWJfY2F0ZWdvcnknLCAnc3ViX2NhdGVnb3J5LmlkJywgJz0nLCAncHJvZHVjdHMuY2F0ZWdvcnlfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIG1haW5fY2F0ZWdvcnknLCAnbWFpbl9jYXRlZ29yeS5pZCcsICc9JywgJ3N1Yl9jYXRlZ29yeS5wYXJlbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWlzaXRpb25faXRlbXMucmVxdWlzaXRpb25faWQnLCAncmVxdWlzaXRpb25zLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHAgaWQ9InN0YXR1cycgLiAkcmVxdWlzaXRpb24tPmlkIC4gJyI+JzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIj5QZW5kaW5nPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAxKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPkFwcHJvdmVkPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tZGFuZ2VyIj5IYWx0PC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+RHJhZnQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8L3A+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXR0YWNobWVudCcsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdFbXBsb3llZScpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXR0YWNobWVudCAuPSAnPGEgaHJlZj0iJyAuIHVybCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpIC4gJyIgdGFyZ2V0PSJfYmxhbmsiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1wcmltYXJ5Ij48aSBjbGFzcz0ibGFzIGxhLXBhcGVyY2xpcCI+PC9pPkF0dGFjaG1lbnQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhdHRhY2htZW50OwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGRpdiBjbGFzcz0iYnRuLWdyb3VwIj4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZHJvcGRvd24tdG9nZ2xlIiBkYXRhLXRvZ2dsZT0iZHJvcGRvd24iPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJzdGF0dXNOYW1lJyAuICRyZXF1aXNpdGlvbi0+aWQgLiAnIj4KICAgICAgICAgICAgICAgICAgICA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJjdXJyZW50Q29sb3IiIGNsYXNzPSJiaSBiaS10aHJlZS1kb3RzLXZlcnRpY2FsIiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGQ9Ik05LjUgMTNhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAweiIvPjwvc3ZnPjwvc3Bhbj48L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICA8dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPgogICAgICAgICAgICAgICAgICAgIDxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0ic2hvd1JlcXVpc3Rpb25EZXRhaWxzIiAgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPjxpIGNsYXNzPSJsYSBsYS1leWUiPjwvaT5WaWV3PC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ucmVxdWlzaXRpb24uZWRpdCcsICRyZXF1aXNpdGlvbi0+aWQpIC4gJz9yZWRpcmVjdD1yZXF1aXNpdGlvbiZlZGl0b3I9YXV0aG9yIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBFZGl0IiBjbGFzcz0icmVxdWlzaXRpb24tZWRpdCI+PGkgY2xhc3M9ImxhIGxhLWVkaXQiPjwvaT5FZGl0PC9hPgogICAgICAgICAgICAgICAgICAgIDwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAzKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiICBvbmNsaWNrPSJzZW5kUmVxdWlzaXRpb24oJCh0aGlzKSkiIGNsYXNzPSJzZW5kUmVxdWlzaXRpb24iIGRhdGEtaWQ9IicgLiAkcmVxdWlzaXRpb24tPmlkIC4gJyIgZGF0YS1zdGF0dXM9IjAiIHRpdGxlPSJDbGljayBIZXJlIFRvIFNlbmQiPjxpIGNsYXNzPSJsYSBsYS1wYXBlci1wbGFuZSI+PC9pPlNlbmQ8L2E+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+CiAgICAgICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1yb2xlPSJkZWxldGUiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5kZXN0cm95JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1kYW5nZXIgZGVsZXRlQnRuIHJlcXVpc2l0aW9uLWRlbGV0ZSIgb25jbGljaz0iZGVsZXRlQnRuKCQodGhpcykpIj48aSBjbGFzcz0ibGFzIGxhLXRyYXNoIj48L2k+Jm5ic3A7RGVsZXRlPC9hPgogICAgICAgICAgICAgICAgICAgICAgICA8L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgdGFyZ2V0PSJfX2JsYW5rIiBocmVmPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5oaXN0b3J5JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIj48aSBjbGFzcz0ibGEgbGEtaGlzdG9yeSIgdGl0bGU9IlJlcXVpc2l0aW9uIEhpc3RvcnkiPjwvaT5SZXF1aXNpdGlvbiBIaXN0b3J5PC9hPjwvbGk8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyIgb25jbGljaz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzKCQodGhpcykpIiBkYXRhLWlkPSInIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciPjxpIGNsYXNzPSJsYSBsYS1tYXAiPjwvaT5UcmFjayBQcm9ncmVzczwvYT48L2xpPjwvdWw+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3N0YXR1cycsICdhdHRhY2htZW50JywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuaW5kZXgnLCBbJ3RpdGxlJyA9PiAnUmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgJ2Zyb20nID0+ICRmcm9tLCAndG8nID0+ICR0bywgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsICdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5oZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGhhbHQoKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAnSGFsdCBSZXF1aXNpdGlvbnMnOwoKICAgICAgICAgICAgJGZyb20gPSByZXF1ZXN0KCktPmhhcygnZnJvbScpID8gcmVxdWVzdCgpLT5nZXQoJ2Zyb20nKSA6IGRhdGUoJ1ktbS0wMScpOwogICAgICAgICAgICAkdG8gPSByZXF1ZXN0KCktPmhhcygndG8nKSA/IHJlcXVlc3QoKS0+Z2V0KCd0bycpIDogZGF0ZSgnWS1tLXQnKTsKICAgICAgICAgICAgJGNhdGVnb3J5X2lkID0gcmVxdWVzdCgpLT5oYXMoJ2NhdGVnb3J5X2lkJykgPyByZXF1ZXN0KCktPmdldCgnY2F0ZWdvcnlfaWQnKSA6IDA7CiAgICAgICAgICAgICRjYXRlZ29yeUlkcyA9IENhdGVnb3J5RGVwYXJ0bWVudDo6d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgIH0pLT5wbHVjaygnY2F0ZWdvcnlfaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkcykKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWydpdGVtcycsICdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5J10pCiAgICAgICAgICAgICAgICAtPndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhdXRob3JfaWQnLCBBdXRoOjp1c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oc3RydG90aW1lKCRmcm9tKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGZyb20pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPj0nLCAkZnJvbSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkdG8pID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkdG8pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPD0nLCAkdG8pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbigkY2F0ZWdvcnlfaWQgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkY2F0ZWdvcnlfaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJGNhdGVnb3J5X2lkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oIWVtcHR5KHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gcmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykgLiAnJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ3JlbWFya3MnLCAnTElLRScsICclJyAuIHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdzdGF0dXMnLCBbMl0pOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoJHJlcXVpc2l0aW9ucykKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsICRyZXF1aXNpdGlvbi0+aWQpIC4gJyIgY2xhc3M9ImJ0biBidG4tbGluayByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nIC4gJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRyZXF1aXNpdGlvbi0+cmVxdWlzaXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZXF1aXNpdGlvbl9kYXRlJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlcXVpc2l0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkcmVxdWlzaXRpb24tPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUpID8gJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWlzaXRpb25JdGVtOjpzZWxlY3QoJ21haW5fY2F0ZWdvcnkubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzLmlkJywgJz0nLCAncmVxdWlzaXRpb25faXRlbXMucHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgc3ViX2NhdGVnb3J5JywgJ3N1Yl9jYXRlZ29yeS5pZCcsICc9JywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBtYWluX2NhdGVnb3J5JywgJ21haW5fY2F0ZWdvcnkuaWQnLCAnPScsICdzdWJfY2F0ZWdvcnkucGFyZW50X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVpc2l0aW9uX2l0ZW1zLnJlcXVpc2l0aW9uX2lkJywgJ3JlcXVpc2l0aW9ucy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignc3RhdHVzJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxwIGlkPSJzdGF0dXMnIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciPic7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+UGVuZGluZzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj5BcHByb3ZlZDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciI+SGFsdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciPkRyYWZ0PC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPC9wPic7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkc3RhdHVzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2F0dGFjaG1lbnQnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhdHRhY2htZW50ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlbXB0eSgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpICYmIGZpbGVfZXhpc3RzKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgLj0gJzxhIGhyZWY9IicgLiB1cmwoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAuICciIHRhcmdldD0iX2JsYW5rIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tcHJpbWFyeSI+PGkgY2xhc3M9ImxhcyBsYS1wYXBlcmNsaXAiPjwvaT5BdHRhY2htZW50PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkYXR0YWNobWVudDsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic3RhdHVzTmFtZScgLiAkcmVxdWlzaXRpb24tPmlkIC4gJyI+CiAgICAgICAgICAgICAgICAgICAgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0iYmkgYmktdGhyZWUtZG90cy12ZXJ0aWNhbCIgdmlld0JveD0iMCAwIDE2IDE2Ij48cGF0aCBkPSJNOS41IDEzYTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAwem0wLTVhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHoiLz48L3N2Zz48L3NwYW4+PC9idXR0b24+CiAgICAgICAgICAgICAgICAgICAgPHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij4KICAgICAgICAgICAgICAgICAgICA8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iVHJhY2tpbmcgUmVxdWlzaXRpb24iIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsICRyZXF1aXNpdGlvbi0+aWQpIC4gJyIgY2xhc3M9InNob3dSZXF1aXN0aW9uRGV0YWlscyIgIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj48aSBjbGFzcz0ibGEgbGEtZXllIj48L2k+IFZpZXc8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPgogICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1yb2xlPSJkZWxldGUiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5kZXN0cm95JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0idGV4dC1kYW5nZXIgZGVsZXRlQnRuIHJlcXVpc2l0aW9uLWRlbGV0ZSIgb25jbGljaz0iZGVsZXRlQnRuKCQodGhpcykpIj48aSBjbGFzcz0ibGFzIGxhLXRyYXNoIj48L2k+Jm5ic3A7RGVsZXRlPC9hPgogICAgICAgICAgICAgICAgICAgIDwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyIgb25jbGljaz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzKCQodGhpcykpIiBkYXRhLWlkPSInIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciPjxpIGNsYXNzPSJsYSBsYS1tYXAiPjwvaT5UcmFjayBQcm9ncmVzczwvYT48L2xpPjwvdWw+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwoKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlZmVyZW5jZV9ubycsICdzdGF0dXMnLCAnYXR0YWNobWVudCcsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLmhhbHQtaW5kZXgnLCBbJ3RpdGxlJyA9PiAnUmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgJ2Zyb20nID0+ICRmcm9tLCAndG8nID0+ICR0bywgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsICdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5oZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTaG93IHRoZSBmb3JtIGZvciBjcmVhdGluZyBhIG5ldyByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGNyZWF0ZSgpCiAgICB7CiAgICAgICAgaWYgKCFhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUpIHsKICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCktPmJhY2soKTsKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0YXNrID0gbnVsbDsKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+aGFzKCd0YXNrLWlkJykpIHsKICAgICAgICAgICAgICAgICR0YXNrID0gUHJvamVjdFRhc2s6OndpdGgoWwogICAgICAgICAgICAgICAgICAgICdzdWJEZWxpdmVyYWJsZS5kZWxpdmVyYWJsZS5wcm9qZWN0JwogICAgICAgICAgICAgICAgXSktPmZpbmRPckZhaWwocmVxdWVzdCgpLT5nZXQoJ3Rhc2staWQnKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRjYXRlZ29yeUlkID0gQ2F0ZWdvcnlEZXBhcnRtZW50Ojp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndpdGgoWydzdWJDYXRlZ29yeSddKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkKQogICAgICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAgICAgJ2lzX2ZpeGVkX2Fzc2V0JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICdpc19jd2lwJyA9PiAwLAogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICRmaXhlZEFzc2V0Q2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndpdGgoWydzdWJDYXRlZ29yeSddKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkKQogICAgICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAgICAgJ2lzX2ZpeGVkX2Fzc2V0JyA9PiAxLAogICAgICAgICAgICAgICAgICAgICdpc19jd2lwJyA9PiAwLAogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICRjd2lwQ2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndpdGgoWydzdWJDYXRlZ29yeSddKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkKQogICAgICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAgICAgJ2lzX2ZpeGVkX2Fzc2V0JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICdpc19jd2lwJyA9PiAxLAogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkdGl0bGUgPSAnQ3JlYXRlIFJlcXVpc2l0aW9uJzsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gbnVsbDsKCiAgICAgICAgICAgICRwcmVmaXggPSAnUlEtJyAuIGRhdGUoJ3knLCBzdHJ0b3RpbWUoZGF0ZSgnWS1tLWQnKSkpIC4gJy0nIC4gYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWUgLiAnLSc7CiAgICAgICAgICAgICRyZWZObyA9IHVuaXF1ZUNvZGUoMTYsICRwcmVmaXgsICdyZXF1aXNpdGlvbnMnLCAnaWQnKTsKCiAgICAgICAgICAgIC8vICRwcm9qZWN0cyA9IFtdOwogICAgICAgICAgICAvLyAkdGFza3MgPSBQcm9qZWN0VGFzazo6d2l0aChbCiAgICAgICAgICAgIC8vICAgICAnc3ViRGVsaXZlcmFibGUuZGVsaXZlcmFibGUucHJvamVjdCcKICAgICAgICAgICAgLy8gXSkKICAgICAgICAgICAgLy8gLT53aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCkKICAgICAgICAgICAgLy8gLT5nZXQoKTsKICAgICAgICAgICAgLy8gaWYoaXNzZXQoJHRhc2tzWzBdKSl7CiAgICAgICAgICAgIC8vICAgICBmb3JlYWNoICgkdGFza3MgYXMgJHRhc2spewogICAgICAgICAgICAvLyAgICAgICAgICRwcm9qZWN0c1tdID0gJHRhc2stPnN1YkRlbGl2ZXJhYmxlLT5kZWxpdmVyYWJsZS0+cHJvamVjdDsKICAgICAgICAgICAgLy8gICAgIH0KICAgICAgICAgICAgLy8gfQoKICAgICAgICAgICAgLy8gJHByb2plY3RzID0gUHJvamVjdDo6d2hlcmVJbigiaWQiLCBhcnJheV9rZXlzKGNvbGxlY3QoJHByb2plY3RzKS0+Z3JvdXBCeSgnaWQnKS0+dG9BcnJheSgpKSktPmdldCgpOwoKICAgICAgICAgICAgJHVuaXRJZCA9IGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCkgPyBhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQgOiBudWxsOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5jcmVhdGUnLCBjb21wYWN0KCd0aXRsZScsICdyZXF1aXNpdGlvbicsICdyZWZObycsICdjYXRlZ29yaWVzJywgJ2ZpeGVkQXNzZXRDYXRlZ29yaWVzJywgJ2N3aXBDYXRlZ29yaWVzJywgJ3VuaXRJZCcsICd0YXNrJykpOwogICAgICAgIH0gY2F0Y2ggKFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGxvYWRQcm9qZWN0V2lzZURlbGl2ZXJhYmxlcyhQcm9qZWN0ICRwcm9qZWN0ID0gbnVsbCkKICAgIHsKICAgICAgICAkZGVsaXZlcmFibGVzID0gW107CiAgICAgICAgZm9yZWFjaCAoQXV0aDo6dXNlcigpLT5wcm9qZWN0VGFzayBhcyAkdGFzaykgewogICAgICAgICAgICBpZiAoJHRhc2stPnN1YkRlbGl2ZXJhYmxlLT5kZWxpdmVyYWJsZS0+cHJvamVjdF9pZCA9PSAkcHJvamVjdC0+aWQpIHsKICAgICAgICAgICAgICAgICRkZWxpdmVyYWJsZXNbXSA9ICR0YXNrLT5zdWJEZWxpdmVyYWJsZS0+ZGVsaXZlcmFibGU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgJGRlbGl2ZXJhYmxlcyA9IGFycmF5X2tleXMoY29sbGVjdCgkZGVsaXZlcmFibGVzKS0+Z3JvdXBCeSgnaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAkZGVsaXZlcmFibGVzID0gRGVsaXZlcmFibGVzOjp3aGVyZUluKCJpZCIsICRkZWxpdmVyYWJsZXMpLT5nZXQoKTsKCiAgICAgICAgJG91dHB1dCA9IFtdOwogICAgICAgICRvdXRwdXRbXSA9ICI8b3B0aW9uPlNlbGVjdCBPbmU8L29wdGlvbj4iOwogICAgICAgIGZvcmVhY2ggKCRkZWxpdmVyYWJsZXMgYXMgJGRlbGl2ZXJhYmxlKSB7CiAgICAgICAgICAgICRvdXRwdXRbXSA9ICc8b3B0aW9uIHZhbHVlPSInIC4gJGRlbGl2ZXJhYmxlLT5pZCAuICciPicgLiAkZGVsaXZlcmFibGUtPm5hbWUgLiAnPC9vcHRpb24+JzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oaW1wbG9kZSgnLCcsICRvdXRwdXQpKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gbG9hZENhdGVnb3J5V2lzZVByb2R1Y3RzKCRjYXRlZ29yeUlkLCBSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXNwb25zZSA9ICcnOwoKICAgICAgICAkY2F0ZWdvcnlJZHMgPSBDYXRlZ29yeURlcGFydG1lbnQ6OndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgoKICAgICAgICAkY2F0ZWdvcnlQcm9kdWN0cyA9IFByb2R1Y3Q6OndpdGgoWwogICAgICAgICAgICAncHJvZHVjdFVuaXQnLCAnY2F0ZWdvcnkuY2F0ZWdvcnknLCAnYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJwogICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmUoJ3N0YXR1cycsICdhcHByb3ZlZCcpCiAgICAgICAgICAgIC0+d2hlbighZW1wdHkoJGNhdGVnb3J5SWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeUlkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeUlkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2NhdGVnb3J5X2lkJywgJGNhdGVnb3J5SWQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3BhcmVudF9pZCcsIHJlcXVlc3QoKS0+Z2V0KCdwYXJlbnRfaWQnKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmUoJ2lzX2ZpbmFsX2Fzc2V0JywgMCkKICAgICAgICAgICAgLT53aGVyZUluKCdjYXRlZ29yeV9pZCcsICRjYXRlZ29yeUlkcyk7CgogICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+cHJvZHVjdHNfaWQpKSB7CiAgICAgICAgICAgICRleGlzdGVkUHJvZHVjdHMgPSBleHBsb2RlKCcsJywgJHJlcXVlc3QtPnByb2R1Y3RzX2lkKTsKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+aGFzKCdzZWxlY3RlZCcpKSB7CiAgICAgICAgICAgICAgICAkZXhpc3RlZFByb2R1Y3RzID0gYXJyYXlfZGlmZigkZXhpc3RlZFByb2R1Y3RzLCBbcmVxdWVzdCgpLT5nZXQoJ3NlbGVjdGVkJyldKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGNhdGVnb3J5UHJvZHVjdHMgPSAkY2F0ZWdvcnlQcm9kdWN0cy0+d2hlcmVOb3RJbignaWQnLCAkZXhpc3RlZFByb2R1Y3RzKTsKICAgICAgICB9CgogICAgICAgICRjYXRlZ29yeVByb2R1Y3RzID0gJGNhdGVnb3J5UHJvZHVjdHMtPmdldCgpOwoKICAgICAgICAkcmVzcG9uc2UgLj0gJzxzZWxlY3QgbmFtZT0icHJvZHVjdF9pZFtdIiBpZD0icHJvZHVjdF8xIiBjbGFzcz0iZm9ybS1jb250cm9sIHNlbGVjdDIgcHJvZHVjdCIgb25jaGFuZ2U9ImdldFVPTSgpIiByZXF1aXJlZD4nOwogICAgICAgICRyZXNwb25zZSAuPSAnPG9wdGlvbiB2YWx1ZT0iIiBkYXRhLXVvbT0iIj5TZWxlY3QgUHJvZHVjdDwvb3B0aW9uPic7CiAgICAgICAgaWYgKCFlbXB0eSgkY2F0ZWdvcnlQcm9kdWN0cykpIHsKICAgICAgICAgICAgZm9yZWFjaCAoJGNhdGVnb3J5UHJvZHVjdHMgYXMgJGRhdGEpIHsKICAgICAgICAgICAgICAgICRyZXNwb25zZSAuPSAnPG9wdGlvbiBkYXRhLXVvbT0iJyAuICgkZGF0YS0+cHJvZHVjdFVuaXQgPyAkZGF0YS0+cHJvZHVjdFVuaXQtPnVuaXRfbmFtZSA6ICcnKSAuICciIHZhbHVlPSInIC4gJGRhdGEtPmlkIC4gJyIgZGF0YS1zdWItY2F0ZWdvcnktaWQ9IicgLiAkZGF0YS0+Y2F0ZWdvcnlfaWQgLiAnIiBkYXRhLWNhdGVnb3J5LWlkPSInIC4gJGRhdGEtPmNhdGVnb3J5LT5wYXJlbnRfaWQgLiAnIiAnIC4gKHJlcXVlc3QoKS0+Z2V0KCdzZWxlY3RlZCcpID09ICRkYXRhLT5pZCA/ICdzZWxlY3RlZCcgOiAnJykgLiAnPicgLiAkZGF0YS0+bmFtZSAuICcgJyAuIGdldFByb2R1Y3RBdHRyaWJ1dGVzRmFzdGVyKCRkYXRhKSAuICc8L29wdGlvbj4nOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJHJlc3BvbnNlIC49ICI8b3B0aW9uIHZhbHVlPScnPk5vIFByb2R1Y3QgRm91bmQhITwvb3B0aW9uPiI7CiAgICAgICAgfQogICAgICAgICRyZXNwb25zZSAuPSAiPC9zZWxlY3Q+IjsKCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gbG9hZENhdGVnb3J5V2lzZVN1YmNhdGVnb3J5KCRjYXRlZ29yeUlkKQogICAgewogICAgICAgICRyZXNwb25zZSA9ICcnOwogICAgICAgICRzdWJDYXRlZ29yeSA9IENhdGVnb3J5Ojp3aGVuKCFlbXB0eSgkY2F0ZWdvcnlJZCksIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5SWQpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3BhcmVudF9pZCcsICRjYXRlZ29yeUlkKTsKICAgICAgICB9KS0+Z2V0KCk7CgogICAgICAgIGlmIChpc3NldCgkc3ViQ2F0ZWdvcnkpICYmIGNvdW50KChhcnJheSkkc3ViQ2F0ZWdvcnkpID4gMCkgewogICAgICAgICAgICAkcmVzcG9uc2UgLj0gJzxvcHRpb24gdmFsdWU9IiI+LS1TZWxlY3QgU3ViY2F0ZWdvcnktLTwvb3B0aW9uPic7CiAgICAgICAgICAgIGZvcmVhY2ggKCRzdWJDYXRlZ29yeSBhcyAkZGF0YSkgewogICAgICAgICAgICAgICAgJHJlc3BvbnNlIC49ICc8b3B0aW9uIHZhbHVlPSInIC4gJGRhdGEtPmlkIC4gJyI+JyAuICRkYXRhLT5uYW1lIC4gJygnIC4gJGRhdGEtPmNvZGUgLiAnKScgLiAnPC9vcHRpb24+JzsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRyZXNwb25zZSAuPSAiPG9wdGlvbiB2YWx1ZT0nJz5ObyBDYXRlZ29yeSBGb3VuZCEhPC9vcHRpb24+IjsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBhIG5ld2x5IGNyZWF0ZWQgcmVzb3VyY2UgaW4gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBzdG9yZShSZXF1ZXN0ICRyZXF1ZXN0LCAkZWRpdCA9IGZhbHNlKQogICAgewogICAgICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgICAgICdyZW1hcmtzJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3Byb2R1Y3RfaWQuKicgPT4gJ3JlcXVpcmVkJywKICAgICAgICBdKTsKCiAgICAgICAgaWYgKCRyZXF1ZXN0LT5oYXNGaWxlKCdmaWxlJykpIHsKICAgICAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICAgICAnZmlsZScgPT4gWydtYXg6MTAwMDAnXSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CgogICAgICAgICAgICAvL1Rhc2sgQnVkZ2V0IFZhbGlkYXRpb24KICAgICAgICAgICAgJHByb2plY3RfdGFza19pZCA9ICgkcmVxdWVzdC0+YXBwcm92YWxfcXR5ID09ICd0cnVlJykgPyAkcmVxdWVzdC0+cHJvamVjdF90YXNrX2lkIDogKGlzc2V0KCRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQpID8gJHJlcXVlc3QtPnByb2plY3RfdGFza19pZCA6IG51bGwpOwogICAgICAgICAgICAkcHJvamVjdFRhc2sgPSBQcm9qZWN0VGFzazo6ZmluZCgkcHJvamVjdF90YXNrX2lkKTsKICAgICAgICAgICAgaWYgKGlzc2V0KCRwcm9qZWN0VGFzay0+aWQpKSB7CiAgICAgICAgICAgICAgICAkY29uc3VtcHRpb25zID0gMDsKICAgICAgICAgICAgICAgIGlmIChpc3NldCgkcHJvamVjdFRhc2stPnJlcXVpc2l0aW9uc1swXSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkcHJvamVjdFRhc2stPnJlcXVpc2l0aW9ucyBhcyAka2V5ID0+ICR0aGlzX3JlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRjb25zdW1wdGlvbnMgKz0gZXN0aW1hdGVkVmFsdWUoJHRoaXNfcmVxdWlzaXRpb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25fY29uc3VtcHRpb24gPSAwOwogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnF0eSBhcyAka2V5ID0+ICRxdHkpIHsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25fY29uc3VtcHRpb24gKz0gUHJvZHVjdDo6ZmluZCgkcmVxdWVzdC0+cHJvZHVjdF9pZFska2V5XSktPnVuaXRfcHJpY2UgKiAkcXR5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRjb25zdW1wdGlvbnMgKz0gJHJlcXVpc2l0aW9uX2NvbnN1bXB0aW9uOwoKICAgICAgICAgICAgICAgIGlmICgkY29uc3VtcHRpb25zID4gJHByb2plY3RUYXNrLT5zdWJEZWxpdmVyYWJsZS0+YnVkZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCdQcm9qZWN0IEJ1ZGdldCBhbGxvY2F0aW9uICgnIC4gJHByb2plY3RUYXNrLT5idWRnZXQgLiAnIEJEVCkgaGFzIGJlZW4gZXhjZWVkZWQgZm9yIHRoaXMgcmVxdWlzaXRpb24gKCcgLiAkcmVxdWlzaXRpb25fY29uc3VtcHRpb24gLiAnIEJEVCkuIFJlbWFpbmluZyBCdWRnZXQgaXMgKCcgLiAoJHByb2plY3RUYXNrLT5zdWJEZWxpdmVyYWJsZS0+YnVkZ2V0ID4gJGNvbnN1bXB0aW9ucyA/ICRwcm9qZWN0VGFzay0+c3ViRGVsaXZlcmFibGUtPmJ1ZGdldCAtICRjb25zdW1wdGlvbnMgOiAwKSAuICcgQkRUKScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vVGFzayBCdWRnZXQgVmFsaWRhdGlvbgoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb24nID0+IHVuaXF1ZVN0cmluZ0dlbmVyYXRvcigpLAogICAgICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubycgPT4gJHJlcXVlc3QtPnJlZmVyZW5jZV9ubywKCiAgICAgICAgICAgICAgICAnaHJfdW5pdF9pZCcgPT4gaXNzZXQoJHJlcXVlc3QtPmhyX3VuaXRfaWQpID8gJHJlcXVlc3QtPmhyX3VuaXRfaWQgOiBudWxsLAoKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9kYXRlJyA9PiBkYXRlKCdZLW0tZCBoOmknLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2RhdGUpKSwKICAgICAgICAgICAgICAgICdhdXRob3JfaWQnID0+ICgkcmVxdWVzdC0+YXBwcm92YWxfcXR5ID09ICd0cnVlJykgPyAkcmVxdWVzdC0+YXV0aG9yX2lkIDogQXV0aDo6dXNlcigpLT5pZCwKCiAgICAgICAgICAgICAgICAncHJvamVjdF9pZCcgPT4gKCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHkgPT0gJ3RydWUnKSA/ICRyZXF1ZXN0LT5wcm9qZWN0X2lkIDogKGlzc2V0KCRyZXF1ZXN0LT5wcm9qZWN0X2lkKSA/ICRyZXF1ZXN0LT5wcm9qZWN0X2lkIDogbnVsbCksCgogICAgICAgICAgICAgICAgJ2RlbGl2ZXJhYmxlX2lkJyA9PiAoJHJlcXVlc3QtPmFwcHJvdmFsX3F0eSA9PSAndHJ1ZScpID8gJHJlcXVlc3QtPmRlbGl2ZXJhYmxlX2lkIDogKGlzc2V0KCRyZXF1ZXN0LT5kZWxpdmVyYWJsZV9pZCkgPyAkcmVxdWVzdC0+ZGVsaXZlcmFibGVfaWQgOiBudWxsKSwKCiAgICAgICAgICAgICAgICAncHJvamVjdF90YXNrX2lkJyA9PiAoJHJlcXVlc3QtPmFwcHJvdmFsX3F0eSA9PSAndHJ1ZScpID8gJHJlcXVlc3QtPnByb2plY3RfdGFza19pZCA6IChpc3NldCgkcmVxdWVzdC0+cHJvamVjdF90YXNrX2lkKSA/ICRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQgOiBudWxsKSwKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICgkcmVxdWVzdC0+YXBwcm92YWxfcXR5ID09ICd0cnVlJykgPyAwIDogMywKICAgICAgICAgICAgICAgICdyZW1hcmtzJyA9PiAkcmVxdWVzdC0+cmVtYXJrcywKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ2ZpbGUnKSkgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50ID0gJHRoaXMtPmZpbGVVcGxvYWQoJHJlcXVlc3QtPmZpbGUoJ2ZpbGUnKSwgJ3VwbG9hZC9yZXF1aXNpdGlvbi1hdHRhY2htZW50cycpOwogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5zYXZlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5xdHkgYXMgJGtleSA9PiAkcXR5KSB7CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtSW5wdXRbXSA9IFsKICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRyZXF1ZXN0LT5wcm9kdWN0X2lkWyRrZXldLAogICAgICAgICAgICAgICAgICAgICdxdHknID0+ICRxdHksCiAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX3F0eScgPT4gKCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHkgPT0gJ3RydWUnKSA/IChpc3NldCgkcmVxdWVzdC0+b2xkX3F0eVska2V5XSkgPyAkcmVxdWVzdC0+b2xkX3F0eVska2V5XSA6ICRxdHkpIDogJHF0eSwKICAgICAgICAgICAgICAgICAgICAnY3JlYXRlZF9hdCcgPT4gZGF0ZSgnWS1tLWQgaDppJyksCiAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYnknID0+ICgkcmVxdWVzdC0+YXBwcm92YWxfcXR5ID09ICd0cnVlJykgPyAkcmVxdWVzdC0+YXV0aG9yX2lkIDogQXV0aDo6dXNlcigpLT5pZCwKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFJlcXVpc2l0aW9uSXRlbTo6aW5zZXJ0KCRyZXF1aXNpdGlvbkl0ZW1JbnB1dCk7CgogICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwgJ3BlbmRpbmcnKTsKCiAgICAgICAgICAgIC8vSW5zZXJ0IG5vdGVzIGxvZ2dpbmcKICAgICAgICAgICAgUmVxdWlzaXRpb25Ob3RlTG9nczo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pZCcgPT4gJHJlcXVpc2l0aW9uLT5pZCwKICAgICAgICAgICAgICAgICdub3RlcycgPT4gJHJlcXVlc3QtPnJlbWFya3MsCiAgICAgICAgICAgICAgICAndHlwZScgPT4gKCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHkgPT0gJ3RydWUnKSA/ICdkZXBhcnRtZW50LWhlYWQnIDogJ3JlcXVpc2l0aW9uJywKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAvL1RyYWNraW5nCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIGlmICgkZWRpdCA9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRyZXF1ZXN0LT53aGVyZV90b19nbykgJiYgJHJlcXVlc3QtPndoZXJlX3RvX2dvID09ICdiYWNrJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdSZXF1aXNpdGlvbiBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgYXBwbGllZCcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1JlcXVpc2l0aW9uIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBhcHBsaWVkJywgJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5pbmRleCcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICRyZXF1aXNpdGlvbjsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBEaXNwbGF5IHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtIFxBcHBcTW9kZWxzXFJlcXVpc2l0aW9uICRyZXF1aXNpdGlvbgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93KFJlcXVpc2l0aW9uICRyZXF1aXNpdGlvbikKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGl0bGUgPSAnUmVxdWlzaXRpb24gU2hvdyc7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aXRoKCdpdGVtcycsICdpdGVtcy5wcm9kdWN0JywgJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnknLCAncHJvamVjdFRhc2snKS0+ZmluZE9yRmFpbCgkcmVxdWlzaXRpb24tPmlkKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuc2hvdycsIGNvbXBhY3QoJ3RpdGxlJywgJ3JlcXVpc2l0aW9uJykpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzaG93UmVxdWlzaXRpb24oJGlkKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAnUmVxdWlzaXRpb24gU2hvdyc7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgICAgICdwcm9qZWN0VGFzay5zdWJEZWxpdmVyYWJsZS5kZWxpdmVyYWJsZS5wcm9qZWN0JywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICAnaXRlbXMucHJvZHVjdC5yZWxJbnZlbnRvcnlTdW1tYXJ5JywKICAgICAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUubG9jYXRpb24nLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS5kZXBhcnRtZW50JywKICAgICAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUudW5pdCcKICAgICAgICAgICAgXSktPmZpbmRPckZhaWwoJGlkKTsKCiAgICAgICAgICAgICRib2R5ID0gVmlldzo6bWFrZSgncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLnNob3cnLAogICAgICAgICAgICAgICAgWydyZXF1aXNpdGlvbicgPT4gJHJlcXVpc2l0aW9uLCAndGl0bGUnID0+ICR0aXRsZV0pOwogICAgICAgICAgICAkY29udGVudHMgPSAkYm9keS0+cmVuZGVyKCk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5oYXMoJ3ZpZXcnKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRjb250ZW50czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oJGNvbnRlbnRzKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGVkaXRpbmcgdGhlIHNwZWNpZmllZCByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcGFyYW0gXEFwcFxNb2RlbHNcUmVxdWlzaXRpb24gJHJlcXVpc2l0aW9uCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGVkaXQoJGlkKQogICAgewogICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgJ3JlcXVpc2l0aW9uSXRlbXMucHJvZHVjdCcKICAgICAgICBdKQogICAgICAgICAgICAtPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCkgJiYgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0VtcGxveWVlJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhdXRob3JfaWQnLCBBdXRoOjp1c2VyKCktPmlkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignYXV0aG9yX2lkJywgaW5jbHVkZVVzZXJzKCkpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1NCVSBIZWFkJyksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2F1dGhvcl9pZCcsIGluY2x1ZGVVc2VycygpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZSgnaWQnLCAkaWQpCiAgICAgICAgICAgIC0+Zmlyc3QoKTsKCiAgICAgICAgaWYgKCFlbXB0eSgkcmVxdWlzaXRpb24pKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAkdGl0bGUgPSAnUmVxdWlzaXRpb24gVXBkYXRlJzsKCiAgICAgICAgICAgICAgICAkY2F0ZWdvcnlJZCA9IENhdGVnb3J5RGVwYXJ0bWVudDo6d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfaWQnLCBhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAgICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgICAgIC0+d2l0aChbJ3N1YkNhdGVnb3J5J10pCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAnaXNfZml4ZWRfYXNzZXQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICdpc19jd2lwJyA9PiAwLAogICAgICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAgICAgLT5nZXQoKTsKICAgICAgICAgICAgICAgICRmaXhlZEFzc2V0Q2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAgICAgLT53aXRoKFsnc3ViQ2F0ZWdvcnknXSkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGNhdGVnb3J5SWQpCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gMSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX2N3aXAnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAgICAgJGN3aXBDYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgICAgICAgICAtPndpdGgoWydzdWJDYXRlZ29yeSddKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZCkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX2ZpeGVkX2Fzc2V0JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICAgICAnaXNfY3dpcCcgPT4gMSwKICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAgICAgJGNhdGVnb3J5ID0gQ2F0ZWdvcnk6OndoZXJlSGFzKCdzdWJDYXRlZ29yeS5wcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaWQnLCAkcmVxdWlzaXRpb24tPml0ZW1zLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICAgICAgfSktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICAkY2F0ZWdvcnlfaWQgPSAoaXNzZXQoJGNhdGVnb3J5LT5pZCkgPyAkY2F0ZWdvcnktPmlkIDogMCk7CgoKICAgICAgICAgICAgICAgICRwcm9qZWN0cyA9IFtdOwogICAgICAgICAgICAgICAgJHRhc2tzID0gUHJvamVjdFRhc2s6OndpdGgoWwogICAgICAgICAgICAgICAgICAgICdzdWJEZWxpdmVyYWJsZS5kZWxpdmVyYWJsZS5wcm9qZWN0JwogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKQogICAgICAgICAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJHRhc2tzWzBdKSkgewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCR0YXNrcyBhcyAkdGFzaykgewogICAgICAgICAgICAgICAgICAgICAgICAkcHJvamVjdHNbXSA9ICR0YXNrLT5zdWJEZWxpdmVyYWJsZS0+ZGVsaXZlcmFibGUtPnByb2plY3Q7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHByb2plY3RzID0gUHJvamVjdDo6d2hlcmVJbigiaWQiLCBhcnJheV9rZXlzKGNvbGxlY3QoJHByb2plY3RzKS0+Z3JvdXBCeSgnaWQnKS0+dG9BcnJheSgpKSktPmdldCgpOwoKICAgICAgICAgICAgICAgICRkZWxpdmVyYWJsZXMgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChpc3NldCgkdGFza3NbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHRhc2tzIGFzICR0YXNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGFzay0+c3ViRGVsaXZlcmFibGUtPmRlbGl2ZXJhYmxlLT5wcm9qZWN0X2lkID09ICRyZXF1aXNpdGlvbi0+cHJvamVjdF9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGRlbGl2ZXJhYmxlc1tdID0gJHRhc2stPnN1YkRlbGl2ZXJhYmxlLT5kZWxpdmVyYWJsZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRkZWxpdmVyYWJsZXMgPSBEZWxpdmVyYWJsZXM6OndoZXJlSW4oImlkIiwgYXJyYXlfa2V5cyhjb2xsZWN0KCRkZWxpdmVyYWJsZXMpLT5ncm91cEJ5KCdpZCcpLT50b0FycmF5KCkpKS0+Z2V0KCk7CgogICAgICAgICAgICAgICAgJG1vZGlmaWVkTmFtZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgJHRhc2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb24tPnByb2plY3RfdGFza19pZCkgewogICAgICAgICAgICAgICAgICAgICR0YXNrID0gUHJvamVjdFRhc2s6OmZpbmRPckZhaWwoJHJlcXVpc2l0aW9uLT5wcm9qZWN0X3Rhc2tfaWQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuZWRpdCcsIGNvbXBhY3QoJ3RpdGxlJywgJ2NhdGVnb3JpZXMnLCAnZml4ZWRBc3NldENhdGVnb3JpZXMnLCAnY3dpcENhdGVnb3JpZXMnLCAncmVxdWlzaXRpb24nLCAncHJvamVjdHMnLCAnZGVsaXZlcmFibGVzJywgJ2NhdGVnb3J5X2lkJywgJ21vZGlmaWVkTmFtZScsICd0YXNrJykpOwogICAgICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5oYXMoJ3JlZGlyZWN0JykgJiYgcmVxdWVzdCgpLT5nZXQoJ3JlZGlyZWN0JykgPT0gJ2xpc3QtdmlldycpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aEVycm9yKCdSZXF1aXNpdGlvbiBub3QgZm91bmQnLCAncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5pbmRleCcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5yZWRpcmVjdEJhY2tXaXRoRXJyb3IoJ1JlcXVpc2l0aW9uIG5vdCBmb3VuZCcsICdwbXMucmVxdWlzaXRpb24ucmVxdWlzaXRpb24uaW5kZXgnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFVwZGF0ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAkcmVxdWVzdAogICAgICogQHBhcmFtIFxBcHBcTW9kZWxzXFJlcXVpc2l0aW9uICRyZXF1aXNpdGlvbgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gdXBkYXRlKFJlcXVlc3QgJHJlcXVlc3QsIFJlcXVpc2l0aW9uICRyZXF1aXNpdGlvbikKICAgIHsKICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ2VkaXRfZmlsZScpKSB7CiAgICAgICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAgICAgJ2VkaXRfZmlsZScgPT4gWydtYXg6MTAwMDAnXSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICAvL0JlZ2luIGRiIHRyYW5zYWN0aW9uLgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAxKSB7CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPnJlbWFya3MgPSAkcmVxdWVzdC0+cmVtYXJrczsKICAgICAgICAgICAgICAgIGlmICgkcmVxdWVzdC0+aGFzRmlsZSgnZWRpdF9maWxlJykpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQgPSAkdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgnZWRpdF9maWxlJyksICd1cGxvYWQvcmVxdWlzaXRpb24tYXR0YWNobWVudHMnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+c2F2ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCAkcmVxdWlzaXRpb24tPmlkKS0+ZGVsZXRlKCk7CgogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlID0gZGF0ZSgnWS1tLWQgaDppOnMnLCBzdHJ0b3RpbWUoJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2RhdGUpKTsKCiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPnJlbWFya3MgPSAkcmVxdWVzdC0+cmVtYXJrczsKICAgICAgICAgICAgICAgIGlmICgkcmVxdWVzdC0+aGFzRmlsZSgnZWRpdF9maWxlJykpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50ID0gJHRoaXMtPmZpbGVVcGxvYWQoJHJlcXVlc3QtPmZpbGUoJ2VkaXRfZmlsZScpLCAndXBsb2FkL3JlcXVpc2l0aW9uLWF0dGFjaG1lbnRzJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnByb2R1Y3RfaWQgYXMgJGtleSA9PiAkcHJvZHVjdF9pZCkgewogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1JbnB1dFtdID0gWwogICAgICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25faWQnID0+ICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdwcm9kdWN0X2lkJyA9PiAkcmVxdWVzdC0+cHJvZHVjdF9pZFska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3F0eScgPT4gJHJlcXVlc3QtPnF0eVska2V5XSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX3F0eScgPT4gKHJlcXVlc3QoKS0+aGFzKCdlZGl0b3InKSAmJiByZXF1ZXN0KCktPmdldCgnZWRpdG9yJykgPT0gImJvc3MiID8gJHJlcXVlc3QtPm9sZF9xdHlbJGtleV0gOiAkcmVxdWVzdC0+cXR5WyRrZXldKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIGg6aTpzJyksCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvbkl0ZW06Omluc2VydCgkcmVxdWlzaXRpb25JdGVtSW5wdXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5oYXMoJ3JlZGlyZWN0JykgJiYgcmVxdWVzdCgpLT5nZXQoJ3JlZGlyZWN0JykgPT0gJ2xpc3QtdmlldycpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1JlcXVpc2l0aW9uIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBVcGRhdGVkJywgJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuaW5kZXgnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1JlcXVpc2l0aW9uIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBVcGRhdGVkJywgJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5pbmRleCcpOwogICAgICAgICAgICB9CgogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGZyb20gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gXEFwcFxNb2RlbHNcUmVxdWlzaXRpb24gJHJlcXVpc2l0aW9uCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGRlc3Ryb3koJGlkKQogICAgewogICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjpmaW5kKCRpZCk7CiAgICAgICAgaWYgKCFpbl9hcnJheSgkcmVxdWlzaXRpb24tPnN0YXR1cywgWzAsIDIsIDNdKSkgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlJlcXVpc2l0aW9uIGNhbm5vdCBiZSBkZWxldGVkISIKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6ZmluZCgkaWQpOwogICAgICAgICRkZWxldGUgPSBSZXF1aXNpdGlvbjo6ZmluZCgkaWQpLT5kZWxldGUoKTsKICAgICAgICBpZiAoJGRlbGV0ZSkgewogICAgICAgICAgICBpZiAoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpIHsKICAgICAgICAgICAgICAgIHVubGluayhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiU29tZXRoaW5nIHdlbnQgd3JvbmchIgogICAgICAgIF0pOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZXN0cm95SXRlbShSZXF1aXNpdGlvbkl0ZW0gJGl0ZW0pCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gJGl0ZW0tPnJlcXVpc2l0aW9uOwogICAgICAgICAgICAkaXRlbS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb24tPml0ZW1zLT5jb3VudCgpIDwgMSkgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5kZWxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkcmVxdWlzaXRpb24tPml0ZW1zLT5jb3VudCgpKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmZwIGxpc3Qgdmlldy4KICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHVzZXJIZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgICRyb3cgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9kYXRlJywgJ3JlcXVpc2l0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0X2NhdGVnb3J5JywgJ3Byb2R1Y3RfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9ieScsICdyZXF1aXNpdGlvbl9ieScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3VuaXQnLCAndW5pdCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2F0dGFjaG1lbnQnLCAnYXR0YWNobWVudCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N0YXR1cycsICdzdGF0dXMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInXQogICAgICAgICk7CiAgICAgICAgcmV0dXJuICRyb3c7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHJlcXVpc2l0aW9uTGlzdFZpZXcoKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAnVXNlciBSZXF1aXNpdGlvbiBMaXN0JzsKICAgICAgICAgICAgJHN0YXR1cyA9IHJlcXVlc3QoKS0+aGFzKCdzdGF0dXMnKSA/IHJlcXVlc3QoKS0+Z2V0KCdzdGF0dXMnKSA6IC0xOwogICAgICAgICAgICAkZnJvbSA9IHJlcXVlc3QoKS0+aGFzKCdmcm9tJykgPyByZXF1ZXN0KCktPmdldCgnZnJvbScpIDogZGF0ZSgnWS1tLTAxJyk7CiAgICAgICAgICAgICR0byA9IHJlcXVlc3QoKS0+aGFzKCd0bycpID8gcmVxdWVzdCgpLT5nZXQoJ3RvJykgOiBkYXRlKCdZLW0tdCcpOwogICAgICAgICAgICAkY2F0ZWdvcnlfaWQgPSByZXF1ZXN0KCktPmhhcygnY2F0ZWdvcnlfaWQnKSA/IHJlcXVlc3QoKS0+Z2V0KCdjYXRlZ29yeV9pZCcpIDogMDsKICAgICAgICAgICAgJGF1dGhvcl9pZCA9IHJlcXVlc3QoKS0+aGFzKCdhdXRob3JfaWQnKSA/IHJlcXVlc3QoKS0+Z2V0KCdhdXRob3JfaWQnKSA6IDA7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdkZXBhcnRtZW50c0xpc3QnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfZGVwYXJ0bWVudF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkaW5jbHVkZVVzZXJzID0gaW5jbHVkZVVzZXJzKCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25Vc2VyTGlzdHMgPSBSZXF1aXNpdGlvbjo6d2hlcmVJbignYXV0aG9yX2lkJywgJGluY2x1ZGVVc2VycykKICAgICAgICAgICAgICAgIC0+am9pbigndXNlcnMnLCAndXNlcnMuaWQnLCAnPScsICdyZXF1aXNpdGlvbnMuYXV0aG9yX2lkJykKICAgICAgICAgICAgICAgIC0+Z3JvdXBCeSgncmVxdWlzaXRpb25zLmF1dGhvcl9pZCcpCiAgICAgICAgICAgICAgICAtPmdldChbJ3VzZXJzLmlkJywgJ3VzZXJzLm5hbWUnXSk7CgogICAgICAgICAgICAkZGF0YSA9IFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJ1JlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvblVzZXJMaXN0cycgPT4gJHJlcXVpc2l0aW9uVXNlckxpc3RzLAogICAgICAgICAgICAgICAgJ2Zyb20nID0+ICRmcm9tLAogICAgICAgICAgICAgICAgJ3RvJyA9PiAkdG8sCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAkc3RhdHVzLAogICAgICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsCiAgICAgICAgICAgICAgICAnYXV0aG9yX2lkJyA9PiAkYXV0aG9yX2lkLAogICAgICAgICAgICAgICAgJ2NhdGVnb3JpZXMnID0+ICRjYXRlZ29yaWVzLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT51c2VySGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF07CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWydpdGVtcycsICdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgJ3JlbFVzZXJzTGlzdCcsICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUudW5pdCddKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdhdXRob3JfaWQnLCAkaW5jbHVkZVVzZXJzKQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkZnJvbSkgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRmcm9tKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJz49JywgJGZyb20pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKSA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJzw9JywgJHRvKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oJHN0YXR1cyA+PSAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJHN0YXR1cyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCRhdXRob3JfaWQgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRhdXRob3JfaWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywgJGF1dGhvcl9pZCk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCRjYXRlZ29yeV9pZCA+IDAsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGNhdGVnb3J5X2lkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZXJlTm90SW4oJ3N0YXR1cycsIFszXSk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkcmVxdWlzaXRpb25zKQogICAgICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBjbGFzcz0iYnRuIGJ0bi1saW5rIHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicgLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRyZXF1aXNpdGlvbi0+cmVxdWlzaXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdyZXF1aXNpdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKSA/ICRyZXF1aXNpdGlvbi0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVpc2l0aW9uSXRlbTo6c2VsZWN0KCdtYWluX2NhdGVnb3J5Lm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIHN1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnkuaWQnLCAnPScsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgbWFpbl9jYXRlZ29yeScsICdtYWluX2NhdGVnb3J5LmlkJywgJz0nLCAnc3ViX2NhdGVnb3J5LnBhcmVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25fYnknLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkcmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+bmFtZSkgPyAkcmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBVc2VyOjpzZWxlY3QoJ25hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigndXNlcnMuaWQnLCAncmVxdWlzaXRpb25zLmF1dGhvcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkcmVxdWlzaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+dW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lKSA/ICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+dW5pdC0+aHJfdW5pdF9zaG9ydF9uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUudW5pdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfc2hvcnRfbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3VuaXQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgXEFwcFxVc2VyOjpzZWxlY3QoJ2hyX3VuaXQuaHJfdW5pdF9zaG9ydF9uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignaHJfYXNfYmFzaWNfaW5mbycsICdocl9hc19iYXNpY19pbmZvLmFzc29jaWF0ZV9pZCcsICc9JywgJ3VzZXJzLmFzc29jaWF0ZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2hyX3VuaXQnLCAnaHJfdW5pdC5ocl91bml0X2lkJywgJz0nLCAnaHJfYXNfYmFzaWNfaW5mby5hc191bml0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3VzZXJzLmlkJywgJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2F0dGFjaG1lbnQnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhdHRhY2htZW50ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlbXB0eSgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpICYmIGZpbGVfZXhpc3RzKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgLj0gJzxhIGhyZWY9IicgLiB1cmwoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAuICciIHRhcmdldD0iX2JsYW5rIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tcHJpbWFyeSI+PGkgY2xhc3M9ImxhcyBsYS1wYXBlcmNsaXAiPjwvaT5BdHRhY2htZW50PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhdHRhY2htZW50OwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcmVxdWlzaXRpb24tPnN0YXR1cyA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+UGVuZGluZzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj5BY2tub3dsZWRnZTwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJlcXVpc2l0aW9uLT5zdGF0dXMgPT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciI+SGFsdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0gJzwvcD4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+PHNwYW4gaWQ9InN0YXR1c05hbWUnIC4gJHZhbHVlcy0+aWQgLiAnIj48c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJjdXJyZW50Q29sb3IiIGNsYXNzPSJiaSBiaS10aHJlZS1kb3RzLXZlcnRpY2FsIiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGQ9Ik05LjUgMTNhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAweiIvPjwvc3ZnPjwvc3Bhbj48L2J1dHRvbj48dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+aXNfc2VuZF90b19yZnAgPT0gJ25vJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnN0YXR1cyAhPSAwICYmIGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3BlbmRpbmcnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBQZW5kaW5nIiBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgIGRhdGEtZGF0YT0icGVuZGluZyIgZGF0YS1zdGF0dXM9IjAiPjxpIGNsYXNzPSJsYSBsYS1wYXVzZSI+PC9pPlBlbmRpbmc8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5lZGl0JywgJHZhbHVlcy0+aWQpIC4gJz9yZWRpcmVjdD1saXN0LXZpZXcmZWRpdG9yPWJvc3MiIHRpdGxlPSJDbGljayBIZXJlIFRvIEVkaXQiPjxpIGNsYXNzPSJsYSBsYS1lZGl0Ij48L2k+RWRpdDwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnN0YXR1cyAhPSAxKSB7CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncmVxdWlzaXRpb24tYWNrbm93bGVkZ2UnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IkNsaWNrIEhlcmUgVG8gQWNrbm93bGVkZ2UiIGNsYXNzPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuIiBvbmNsaWNrPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuKCQodGhpcykpIiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiBkYXRhLWRhdGE9ImFja25vd2xlZGdlZCIgZGF0YS1zdGF0dXM9IjEiPjxpIGNsYXNzPSJsYSBsYS1jaGVjayI+PC9pPkFja25vd2xlZGdlPC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ2hhbHQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5zdGF0dXMgIT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IkNsaWNrIEhlcmUgVG8gSGFsdCIgY2xhc3M9InJlcXVpc2l0aW9uQXBwcm92ZWRCdG4iIG9uY2xpY2s9InJlcXVpc2l0aW9uQXBwcm92ZWRCdG4oJCh0aGlzKSkiIGRhdGEtZGF0YT0iaGFsdCIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgZGF0YS1zdGF0dXM9IjIiPjxpIGNsYXNzPSJsYSBsYS1iYW4iPjwvaT5IYWx0PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3NlbmQtdG8tcmZwJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgY2xhc3M9InNlbmRUb1B1cmNoYXNlRGVwYXJ0bWVudCIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5zZW5kLnRvLnB1cmNoYXNlLmRlcGFydG1lbnQnKSAuICciIG9uY2xpY2s9InNlbmRUb1B1cmNoYXNlRGVwYXJ0bWVudCgkKHRoaXMpKSIgIGRhdGEtaWQ9IicgLiAkdmFsdWVzLT5pZCAuICciICB0aXRsZT0iU2VuZCBUbyBwcm9jdXJlbWVudCI+U2VuZCBUbyBQcm9jdXJlbWVudDwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iVHJhY2tpbmcgUmVxdWlzaXRpb24iIGNsYXNzPSJ0cmFja2luZ1JlcXVpc3Rpb25TdGF0dXMiIG9uY2xpY2s9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cygnIC4gJHZhbHVlcy0+aWQgLiAnKSIgPjxpIGNsYXNzPSJsYSBsYS1tYXAiPjwvaT5UcmFjayBQcm9ncmVzczwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24uaGlzdG9yeScsICR2YWx1ZXMtPmlkKSAuICciPjxpIGNsYXNzPSJsYSBsYS1oaXN0b3J5IiB0aXRsZT0iUmVxdWlzaXRpb24gSGlzdG9yeSI+PC9pPlJlcXVpc2l0aW9uIEhpc3Rvcnk8L2E+PC9saTwvYT48L2xpPic7CgoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzwvdWw+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwoKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlZmVyZW5jZV9ubycsICdzdGF0dXMnLCAnYXR0YWNobWVudCcsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uLWxpc3QtaW5kZXgnLCAkZGF0YSk7CiAgICAgICAgfSBjYXRjaCAoVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJmcCBsaXN0IHZpZXcgc2VyYXJjaC4KICAgICAqIFNlYXJjaCBiZXR3ZWVuIGZyb20gYW5kIHRvIGRhdGUgYW5kIGFsc28gdXNlciBjYW4gc2VhcmNoIGJ5IGVtcGxveWVlCiAgICAgKiBAcGFyYW0gXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIGZ1bmN0aW9uIG5lZWR0b2tlZXAoKQogICAgewogICAgICAgICRyZXF1aXN0aW9ucyA9IFJlcXVpc2l0aW9uOjp3aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgICAgICAtPndoZXJlKCdzdGF0dXMnLCAwKQogICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAkcmVxdWlzdGlvbl9kYXRhID0gW107CiAgICAgICAgZm9yZWFjaCAoJHJlcXVpc3Rpb25zIGFzICRyZXF1aXN0aW9uKSB7CiAgICAgICAgICAgICR0cCA9IDA7CiAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1aXN0aW9uLT5pdGVtcyBhcyAkaXRlbSkgewogICAgICAgICAgICAgICAgJHRwICs9ICgkaXRlbS0+cHJvZHVjdC0+dW5pdF9wcmljZSAqICRpdGVtLT5xdHkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICAkcmVxdWlzdGlvbi0+dG90YWxfcHJpY2UgPSAkdHA7CiAgICAgICAgICAgIGZvcmVhY2ggKEF1dGg6OnVzZXIoKS0+cmVsQXBwcm92YWxSYW5nZSBhcyAkcmFuZ2UpIHsKICAgICAgICAgICAgICAgIGlmICgkcmFuZ2UtPm1pbl9hbW91bnQgPD0gJHJlcXVpc3Rpb24tPnRvdGFsX3ByaWNlICYmICRyYW5nZS0+bWF4X2Ftb3VudCA+PSAkcmVxdWlzdGlvbi0+dG90YWxfcHJpY2UpIHsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzdGlvbl9kYXRhW10gPSAkcmVxdWlzdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gJHRoaXMtPnBhZ2luYXRlKCRyZXF1aXN0aW9uX2RhdGEsIDMwKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJmcCBsaXN0IHZpZXcuCiAgICAgKiBDaGFuZ2UgcmVxdWlzaXRvbiBzdGF0dXMgKEFwcHJvdmUgYW5kIHJlamVjdGVkKQogICAgICogQHBhcmFtIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAkcmVxdWVzdAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gdG9nZ2xlUmVxdWlzaXRpb25TdGF0dXMoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6d2hlcmUoJ2lkJywgJHJlcXVlc3QtPmlkKS0+Zmlyc3QoKTsKICAgICAgICBpZiAoaXNzZXQoJHJlcXVpc2l0aW9uLT5pZCkpIHsKCiAgICAgICAgICAgICRuZXdTdGF0dXMgPSAkcmVxdWVzdC0+c3RhdHVzOwogICAgICAgICAgICAkbmV3VGV4dCA9ICRuZXdTdGF0dXMgPT0gMSA/ICdBY2tub3dsZWRnZScgOiAoKCRuZXdTdGF0dXMgPT0gMikgPyAnSGFsdCcgOiAnUGVuZGluZycpOwogICAgICAgICAgICAkbmV3QXBwcm92ZWQgPSAkbmV3U3RhdHVzID09IDEgPyAxIDogKCgkbmV3U3RhdHVzID09IDIpID8gMSA6IE51bGwpOwogICAgICAgICAgICAkbmV3TWVzc2FnZSA9ICRuZXdTdGF0dXMgPT0gMSA/ICdTdWNjZXNmdWxseSBVcGRhdGVkIFRvIEFja25vd2xlZGdlbWVudCcgOiAoKCRuZXdTdGF0dXMgPT0gMikgPyAnU3VjY2VzZnVsbHkgVXBkYXRlZCBUbyBIYWx0JyA6ICgoJG5ld1N0YXR1cyA9PSAwKSA/ICdTdWNjZXNmdWxseSBTZW5kIHRvICcgLiAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ0RlcGFydG1lbnQtSGVhZCcpID8gJ1NCVSBoZWFkJyA6IChhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnU0JVIEhlYWQnKSA/ICdNYW5hZ2VtZW50JyA6ICdEZXBhcnRtZW50IGhlYWQnKSkgOiAnU3VjY2VzZnVsbHkgVXBkYXRlZCBUbyBQZW5kaW5nJykpOwoKICAgICAgICAgICAgJHVwZGF0ZSA9ICRyZXF1aXNpdGlvbi0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICRuZXdTdGF0dXMsCiAgICAgICAgICAgICAgICAnYXBwcm92ZWRfaWQnID0+ICRuZXdBcHByb3ZlZCwKICAgICAgICAgICAgICAgICdhZG1pbl9yZW1hcmsnID0+ICRyZXF1ZXN0LT5hZG1pbl9yZW1hcmssCiAgICAgICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gZGF0ZSgnWS1tLWQgSDppOnMnKSwKICAgICAgICAgICAgICAgICd1cGRhdGVkX2J5JyA9PiBBdXRoOjp1c2VyKCktPmlkLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2J5JyA9PiBBdXRoOjp1c2VyKCktPmlkCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICBpZiAoJG5ld1N0YXR1cyA9PSAxKSB7CiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwgJ2FwcHJvdmVkJyk7CgogICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5zdG9yZS5pbnZlbnRvcnkuY29tcGFyZScsICRyZXF1aXNpdGlvbi0+aWQpIC4gJyIgZGF0YS10aXRsZT0iUmVxdWlzaXRpb24gRGV0YWlscyI+UmVmZXJlbmNlIE5vOicgLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuICcuV2F0dGluZyBmb3IgUHJvY3VyZW1lbnQvRGVsaXZlcnkuPC9zcGFuPic7CgogICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsIGdldE1hbmFnZXJJbmZvKCdTdG9yZS1NYW5hZ2VyJywgJHJlcXVpc2l0aW9uLT5ocl91bml0X2lkKSwgJG1lc3NhZ2UsICd1bnJlYWQnLCAnc2VuZC10by1zdG9yZScsICcnKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJ1N1Y2Nlc2Z1bGx5IFVwZGF0ZWQgVG8gQWNrbm93bGVkZ2VtZW50JywKICAgICAgICAgICAgICAgICAgICAnbmV3X3RleHQnID0+ICRuZXdUZXh0CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCRuZXdTdGF0dXMgPT0gMCkgewogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbi0+aWQsICdwZW5kaW5nJyk7CiAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJyAuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCAkcmVxdWlzaXRpb24tPmlkKSAuICciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonIC4gJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnLiBXYXR0aW5nIGZvciBhcHByb3ZhbC48L3NwYW4+JzsKCiAgICAgICAgICAgICAgICAkcmVjZWl2ZXIgPSBnZXREZXBhcnRtZW50SGVhZCgkcmVxdWlzaXRpb24tPmF1dGhvcl9pZCk7CiAgICAgICAgICAgICAgICAkcmVjZWl2ZXJfc2x1ZyA9ICdzZW5kLXRvLWRlcGFydG1lbnQtaGVhZCc7CgogICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSkgewogICAgICAgICAgICAgICAgICAgICRyZWNlaXZlciA9IGdldE1hbmFnZXJJbmZvKCdTQlUgSGVhZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCk7CiAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVyX3NsdWcgPSAnc2VuZC10by1zYnUtaGVhZCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdTQlUgSGVhZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVyID0gZ2V0TWFuYWdlckluZm8oJ01hbmFnZW1lbnQnKTsKICAgICAgICAgICAgICAgICAgICAkcmVjZWl2ZXJfc2x1ZyA9ICdzZW5kLXRvLW1hbmFnbWVudCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsICRyZWNlaXZlciwgJG1lc3NhZ2UsICd1bnJlYWQnLCAkcmVjZWl2ZXJfc2x1ZywgJycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJHVwZGF0ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkbmV3TWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICAnbmV3X3RleHQnID0+ICRuZXdUZXh0CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9uZXcgdHJhY2tpbmcgaGlzdG9yeQogICAgICAgICAgICAkc3RhZ2UgPSAnJzsKICAgICAgICAgICAgJG5vdGUgPSAnJzsKCiAgICAgICAgICAgICR1c2VyID0gYXV0aCgpLT51c2VyKCk7CiAgICAgICAgICAgICRyb2xlID0gJHVzZXItPnJvbGVzLT5maXJzdCgpLT5uYW1lID8/ICdTeXN0ZW0nOwoKICAgICAgICAgICAgaWYgKCRuZXdTdGF0dXMgPT0gMCkgewogICAgICAgICAgICAgICAgLy8gU2VuZGluZyBmb3J3YXJkCiAgICAgICAgICAgICAgICBpZiAoJHJvbGUgPT0gJ0RlcGFydG1lbnQtSGVhZCcpIHsKICAgICAgICAgICAgICAgICAgICAkc3RhZ2UgPSAnc2VudF90b19zYnVfaGVhZCc7CiAgICAgICAgICAgICAgICAgICAgJG5vdGUgPSAnU2VudCB0byBTQlUgSGVhZCBmb3IgYXBwcm92YWwnOwogICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyb2xlID09ICdNYW5hZ2VtZW50JykgewogICAgICAgICAgICAgICAgICAgICRzdGFnZSA9ICdzZW50X3RvX21hbmFnZW1lbnQnOwogICAgICAgICAgICAgICAgICAgICRub3RlID0gJ1NlbnQgdG8gTWFuYWdlbWVudCBmb3IgYXBwcm92YWwnOwogICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRyb2xlID09ICdBY2NvdW50cycpIHsKICAgICAgICAgICAgICAgICAgICAkc3RhZ2UgPSAnc2VudF90b19zdG9yZSc7CiAgICAgICAgICAgICAgICAgICAgJG5vdGUgPSAnU2VudCB0byBTdG9yZSBmb3IgcHJvY2Vzc2luZyc7CiAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJvbGUgPT0gJ1N0b3JlLU1hbmFnZXInKSB7CiAgICAgICAgICAgICAgICAgICAgJHN0YWdlID0gJ3NlbnRfdG9fcHVyY2hhc2UnOwogICAgICAgICAgICAgICAgICAgICRub3RlID0gJ1NlbnQgdG8gUHVyY2hhc2UgRGVwYXJ0bWVudCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRzdGFnZSA9ICdzZW50X3RvX2RlcGFydG1lbnRfaGVhZCc7CiAgICAgICAgICAgICAgICAgICAgJG5vdGUgPSAnU2VudCB0byBEZXBhcnRtZW50IEhlYWQgZm9yIGFwcHJvdmFsJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlaWYgKCRuZXdTdGF0dXMgPT0gMSkgewogICAgICAgICAgICAgICAgLy8gQXBwcm92YWwgbG9naWMKICAgICAgICAgICAgICAgIGlmICgkcm9sZSA9PSAnQWNjb3VudHMnKSB7CiAgICAgICAgICAgICAgICAgICAgJHN0YWdlID0gJ2FwcHJvdmVkX2J5X2ZpbmFuY2UnOwogICAgICAgICAgICAgICAgICAgICRub3RlID0gJ0FwcHJvdmVkIGJ5IEZpbmFuY2UgYW5kIFNlbmQgdG8gU3RvcmUgRGVwYXJ0bWVudCc7CiAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJvbGUgPT0gJ0RlcGFydG1lbnQtSGVhZCcpIHsKICAgICAgICAgICAgICAgICAgICAkc3RhZ2UgPSAnYXBwcm92ZWRfYnlfZGVwYXJ0bWVudF9oZWFkJzsKICAgICAgICAgICAgICAgICAgICAkbm90ZSA9ICdBcHByb3ZlZCBieSBEZXBhcnRtZW50IEhlYWQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZWlmICgkcm9sZSA9PSAnTWFuYWdlbWVudCcpIHsKICAgICAgICAgICAgICAgICAgICAkc3RhZ2UgPSAnYXBwcm92ZWRfYnlfbWFuYWdlbWVudCc7CiAgICAgICAgICAgICAgICAgICAgJG5vdGUgPSAnQXBwcm92ZWQgYnkgTWFuYWdlbWVudCc7CiAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJvbGUgPT0gJ1N0b3JlLU1hbmFnZXInKSB7CiAgICAgICAgICAgICAgICAgICAgJHN0YWdlID0gJ2FwcHJvdmVkX2J5X3N0b3JlJzsKICAgICAgICAgICAgICAgICAgICAkbm90ZSA9ICdBcHByb3ZlZCBieSBTdG9yZSc7CiAgICAgICAgICAgICAgICB9IGVsc2VpZiAoJHJvbGUgPT0gJ1B1cmNoYXNlLURlcGFydG1lbnQnKSB7CiAgICAgICAgICAgICAgICAgICAgJHN0YWdlID0gJ2FwcHJvdmVkX2J5X3B1cmNoYXNlJzsKICAgICAgICAgICAgICAgICAgICAkbm90ZSA9ICdBcHByb3ZlZCBieSBQdXJjaGFzZSBEZXBhcnRtZW50JzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJHN0YWdlID0gJ2FwcHJvdmVkX2J5XycgLiBzdHJ0b2xvd2VyKHN0cl9yZXBsYWNlKFsnICcsICctJ10sICdfJywgJHJvbGUpKTsKICAgICAgICAgICAgICAgICAgICAkbm90ZSA9ICJBcHByb3ZlZCBieSB7JHJvbGV9IjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlaWYgKCRuZXdTdGF0dXMgPT0gMikgewogICAgICAgICAgICAgICAgJHN0YWdlID0gJ2hhbHRlZCc7CiAgICAgICAgICAgICAgICAkbm90ZSA9ICdSZXF1aXNpdGlvbiBoYXMgYmVlbiBoYWx0ZWQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXF1aXNpdGlvblRyYWNraW5nSGlzdG9yeSgKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAkc3RhZ2UsCiAgICAgICAgICAgICAgICAkbm90ZQogICAgICAgICAgICApOwoKCiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU29tZXRoaW5nIFdlbnQgV3JvbmchJwogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAnbWVzc2FnZScgPT4gJ0RhdGEgbm90IGZvdW5kIScKICAgICAgICBdKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gaGFsdFJlcXVpc2l0aW9uU3RhdHVzKFJlcXVlc3RzXFBtc1xSZXF1aXNpdGlvblJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CgogICAgICAgIC8vRmluZCByZXF1aXN0aW9uCiAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OmZpbmRPckZhaWwoJHJlcXVlc3QtPmlkKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAvL0lmIGZpbmQgdGhlbiB1cGRhdGUKICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT51cGRhdGUoWwogICAgICAgICAgICAgICAgJ2FkbWluX3JlbWFyaycgPT4gJHJlcXVlc3QtPmFkbWluX3JlbWFyaywKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDIsCiAgICAgICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gZGF0ZSgnWS1tLWQgSDppOnMnKSwKICAgICAgICAgICAgICAgICd1cGRhdGVkX2J5JyA9PiBBdXRoOjp1c2VyKCktPmlkCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9IicgLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywgJHJlcXVpc2l0aW9uLT5pZCkgLiAnIiBkYXRhLXRpdGxlPSJSZXF1aXNpdGlvbiBEZXRhaWxzIj5SZWZlcmVuY2UgTm86JyAuICRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJy4gRGVwYXJ0bWVudCBIZWFkIEhhbHQgVGhpcyBSZXF1aXNpdGlvbi4uPC9zcGFuPic7CiAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCcnLCAkcmVxdWlzaXRpb24tPmF1dGhvcl9pZCwgJG1lc3NhZ2UsICd1bnJlYWQnLCAncmVxdWlzaXRpb24nLCAnJyk7CgogICAgICAgICAgICAvL1JlcXVpc3Rpb24gdHJhY2tpbmcgZnVuY3Rpb24gY2FsbAogICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwgJ2hhbHQnLCAkcmVxdWVzdC0+YWRtaW5fcmVtYXJrKTsKICAgICAgICAgICAgLy9Ob3R0aWZpY2F0aW9uCiAgICAgICAgICAgIC8vSWYgc3VjY2VzcyB0aGVuIHJldHVybiB3aXRoIHN1Y2Nlc3MgbWVzc2FnZQogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoU3VjY2VzcygnUmVxdWlzaXRpb24gU3VjY2Vzc2Z1bGx5IEhhbHQnKTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHNob3dUcmFja2luZyhSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aXRoKCdyZXF1aXNpdGlvblRyYWNraW5nJyktPmZpbmRPckZhaWwoJHJlcXVlc3QtPmlkKTsKCiAgICAgICAgICAgICRoaXN0b3JpZXMgPSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25TdGFnZUhpc3Rvcnk6OndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1ZXN0LT5pZCkKICAgICAgICAgICAgICAgIC0+d2l0aCgnY3JlYXRlZEJ5JykKICAgICAgICAgICAgICAgIC0+b3JkZXJCeSgnc3RhZ2VfdXBkYXRlZF9hdCcsICdkZXNjJykKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAncmVzdWx0JyA9PiAnc3VjY2VzcycsCiAgICAgICAgICAgICAgICAnYm9keScgPT4gVmlldzo6bWFrZSgncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLnRyYWNraW5nJywgWwogICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbicgPT4gJHJlcXVpc2l0aW9uLAogICAgICAgICAgICAgICAgICAgICdoaXN0b3JpZXMnID0+ICRoaXN0b3JpZXMKICAgICAgICAgICAgICAgIF0pLT5yZW5kZXIoKQogICAgICAgICAgICBdKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAncmVzdWx0JyA9PiAnZXJyb3InLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICR0aC0+Z2V0TWVzc2FnZSgpCiAgICAgICAgICAgIF0sIDUwMCk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBub3RpZmljYXRpb25IZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgICRyb3cgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ2RhdGUnLCAnY3JlYXRlZF9hdCcsICd0ZXh0LWNlbnRlcicsICd3aWR0aDoxNSUnXSwKICAgICAgICAgICAgWydtZXNzYWdlcycsICdtZXNzYWdlcycsICd0ZXh0LWxlZnQnXSwKICAgICAgICAgICAgWydzdGF0dXMnLCAndHlwZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlciBhY3Rpb24nLCAnd2lkdGg6MTUlJ10KICAgICAgICApOwogICAgICAgIHJldHVybiAkcm93OwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBub3RpZmljYXRpb25BbGwoKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAiTm90aWZpY2F0aW9uIjsKICAgICAgICAgICAgJG5vdGlmaWNhdGlvbiA9IE5vdGlmaWNhdGlvbjo6d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXIuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCBBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkdW5yZWFkTm90aWZpY2F0aW9uID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCktPndoZXJlKCd0eXBlJywgJ3VucmVhZCcpLT5jb3VudCgpOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoJG5vdGlmaWNhdGlvbikKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ2RhdGUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHZhbHVlcy0+Y3JlYXRlZF9hdCkpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdjcmVhdGVkX2F0JywgJG9yZGVyKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignc3RhdHVzJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8cCBpZD0idHlwZScgLiAkdmFsdWVzLT5pZCAuICciIGNsYXNzPSJ0eXBlIj4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnR5cGUgPT0gJ3JlYWQnKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPHNwYW4gY2xhc3M9ImJ0biBidG4tc20gYnRuLXN1Y2Nlc3MiPjxpIGNsYXNzPSJsYXMgbGEtY2hlY2stY2lyY2xlIj48L2k+PC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49ICc8c3BhbiBjbGFzcz0iYnRuIGJ0bi1zbSBidG4td2FybmluZyI+PGkgY2xhc3M9ImxhcyBsYS1pbmJveCI+PC9pPjwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSAnPC9wPic7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkc3RhdHVzOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICc8cCBpZD0iYWN0aW9uJyAuICR2YWx1ZXMtPmlkIC4gJyIgY2xhc3M9ImFjdGlvbiI+JzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnR5cGUgPT0gJ3VucmVhZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9InN0YXR1c05hbWUnIC4gJHZhbHVlcy0+aWQgLiAnIj4KICAgICAgICAgICAgICAgICAgICA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJjdXJyZW50Q29sb3IiIGNsYXNzPSJiaSBiaS10aHJlZS1kb3RzLXZlcnRpY2FsIiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGQ9Ik05LjUgMTNhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAweiIvPjwvc3ZnPjwvc3Bhbj48L2J1dHRvbj48dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJtYXJrQXNSZWFkIiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiBvbmNsaWNrPSJtYXJrQXNSZWFkKCQodGhpcykpIiB0aXRsZT0iTWFyayBBcyBSZWFkIj48aSBjbGFzcz0ibGEgbGEtY2hlY2siPjwvaT4gTWFyayBBcyBSZWFkPC9hPjwvbGk+PC91bD48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJ0FscmVhZHkgUmVhZCc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzwvcD4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmVzY2FwZUNvbHVtbnMoW10pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsnbWVzc2FnZXMnLCAnc3RhdHVzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMubm90aWZpY2F0aW9uLWxpc3QnLCBbJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAndW5yZWFkTm90aWZpY2F0aW9uJyA9PiAkdW5yZWFkTm90aWZpY2F0aW9uLCAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPm5vdGlmaWNhdGlvbkhlYWRlckNvbHVtbnMoKV0pOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBtYXJrQXNSZWFkKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHJlc3BvbnNlID0gW107CiAgICAgICAgLy9GaW5kIG5vdGlmaWNhdGlvbgogICAgICAgICRub3RpZmljYXRpb24gPSBOb3RpZmljYXRpb246OndoZXJlKCdpZCcsICRyZXF1ZXN0LT5pZCktPmZpcnN0KCk7CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgIGlmIChpc3NldCgkbm90aWZpY2F0aW9uKSkgewogICAgICAgICAgICAgICAgJG5vdGlmaWNhdGlvbi0+dHlwZSA9ICdyZWFkJzsKICAgICAgICAgICAgICAgICRub3RpZmljYXRpb24tPnJlYWRfYXQgPSBkYXRlKCdZLW0tZCBoOmk6cycpOwogICAgICAgICAgICAgICAgJG5vdGlmaWNhdGlvbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnc3VjY2Vzcyc7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdTdWNjZXNzZnVsbHkgUmVhZCBOb3RpZmljYXRpb24nOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWyd0b3RhbF9ub3RpZmljYXRpb24nXSA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ3R5cGUnLCAndW5yZWFkJyktPndoZXJlKCd1c2VyX2lkJywgYXV0aDo6dXNlcigpLT5pZCktPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlci5lbXBsb3llZScsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCBBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pLT5jb3VudCgpOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnTm8gTm90aWZpY2F0aW9uIEZvdW5kJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsndG90YWxfbm90aWZpY2F0aW9uJ10gPSBOb3RpZmljYXRpb246OndoZXJlKCd0eXBlJywgJ3VucmVhZCcpLT53aGVyZSgndXNlcl9pZCcsIGF1dGg6OnVzZXIoKS0+aWQpLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXIuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KS0+Y291bnQoKTsKICAgICAgICAgICAgfQoKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgovLyAgICBwdWJsaWMgZnVuY3Rpb24gbWFya0FzUmVhZEFsbChSZXF1ZXN0ICRyZXF1ZXN0KQovLyAgICB7Ci8vICAgICAgICAkcmVzcG9uc2UgPSBbXTsKLy8KLy8gICAgICAgICRub3RpZmljYXRpb25zID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCktPndoZXJlKCd0eXBlJywgJ3VucmVhZCcpLT5nZXQoKTsKLy8KLy8gICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7Ci8vICAgICAgICB0cnkgewovLwovLyAgICAgICAgICAgIGlmIChjb3VudCgkbm90aWZpY2F0aW9ucykgPiAwKSB7Ci8vCi8vICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRub3RpZmljYXRpb25zIGFzICRub3RpZmljYXRpb24pIHsKLy8gICAgICAgICAgICAgICAgICAgIE5vdGlmaWNhdGlvbjo6d2hlcmUoJ2lkJywgJG5vdGlmaWNhdGlvbi0+aWQpLT51cGRhdGUoCi8vICAgICAgICAgICAgICAgICAgICAgICAgWyd0eXBlJyA9PiAncmVhZCcsICdyZWFkX2F0JyA9PiBkYXRlKCdZLW0tZCBoOmk6cycpXQovLyAgICAgICAgICAgICAgICAgICAgKTsKLy8gICAgICAgICAgICAgICAgfQovLyAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwovLyAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdTdWNjZXNzZnVsbHkgUmVhZCBOb3RpZmljYXRpb24nOwovLyAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3RvdGFsX25vdGlmaWNhdGlvbiddID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndHlwZScsICd1bnJlYWQnKS0+d2hlcmUoJ3VzZXJfaWQnLCBhdXRoOjp1c2VyKCktPmlkKS0+d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewovLyAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXIuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7Ci8vICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCBBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKLy8gICAgICAgICAgICAgICAgICAgIH0pOwovLyAgICAgICAgICAgICAgICB9KS0+Y291bnQoKTsKLy8KLy8gICAgICAgICAgICB9IGVsc2UgewovLyAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKLy8gICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnTm8gTm90aWZpY2F0aW9uIEZvdW5kJzsKLy8gICAgICAgICAgICAgICAgJHJlc3BvbnNlWyd0b3RhbF9ub3RpZmljYXRpb24nXSA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ3R5cGUnLCAndW5yZWFkJyktPndoZXJlKCd1c2VyX2lkJywgYXV0aDo6dXNlcigpLT5pZCktPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKLy8gICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2VyLmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewovLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7Ci8vICAgICAgICAgICAgICAgICAgICB9KTsKLy8gICAgICAgICAgICAgICAgfSktPmNvdW50KCk7Ci8vICAgICAgICAgICAgfQovLwovLyAgICAgICAgICAgIERCOjpjb21taXQoKTsKLy8KLy8gICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7Ci8vICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7Ci8vCi8vICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7Ci8vICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAkdGgtPmdldE1lc3NhZ2UoKTsKLy8gICAgICAgIH0KLy8KLy8gICAgICAgIHJldHVybiAkcmVzcG9uc2U7Ci8vICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gbWFya0FzUmVhZEFsbChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXNwb25zZSA9IFtdOwoKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIEdldCB1bnJlYWQgbm90aWZpY2F0aW9ucyBmb3IgdGhpcyB1c2VyL2RlcGFydG1lbnQKICAgICAgICAgICAgJG5vdGlmaWNhdGlvbnMgPSBOb3RpZmljYXRpb246OndoZXJlKCd0eXBlJywgJ3VucmVhZCcpCiAgICAgICAgICAgICAgICAtPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBEZXBhcnRtZW50IG5vdGlmaWNhdGlvbnMgZm9yIGFjY291bnQtbWFuYWdlcgogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2VyLmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBQZXJzb25hbCBub3RpZmljYXRpb25zIGZvciBub3JtYWwgdXNlcnMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+aWQoKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgIGlmICgkbm90aWZpY2F0aW9ucy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRub3RpZmljYXRpb25zIGFzICRub3RpZmljYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAkbm90aWZpY2F0aW9uLT51cGRhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgICAgPT4gJ3JlYWQnLAogICAgICAgICAgICAgICAgICAgICAgICAncmVhZF9hdCcgPT4gbm93KCksCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ1N1Y2Nlc3NmdWxseSBSZWFkIE5vdGlmaWNhdGlvbic7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ05vIE5vdGlmaWNhdGlvbiBGb3VuZCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVucmVhZCBjb3VudCB1c2luZyBzYW1lIGZpbHRlcgogICAgICAgICAgICAkcmVzcG9uc2VbJ3RvdGFsX25vdGlmaWNhdGlvbiddID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndHlwZScsICd1bnJlYWQnKQogICAgICAgICAgICAgICAgLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXIuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT5pZCgpKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmNvdW50KCk7CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAkdGgtPmdldE1lc3NhZ2UoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgoKCgogICAgcHVibGljIGZ1bmN0aW9uIGRIZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgICRyb3cgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9kYXRlJywgJ3JlcXVpc2l0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZWxpdmVyZWRfcmVmX25vJywgJ2RlbGl2ZXJlZF9yZWZfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZWxpdmVyeV9kYXRlJywgJ2RlbGl2ZXJ5X2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydjYXRlZ29yeScsICdjYXRlZ29yeScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0JywgJ3Byb2R1Y3QnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZWxpdmVyeV9xdHknLCAnZGVsaXZlcnlfcXR5JywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlcicsICd3aWR0aDoxNSUnXQogICAgICAgICk7CgogICAgICAgIHJldHVybiAkcm93OwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZWxpdmVyZWRSZXF1aXNpdGlvbkxpc3QoKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRzdGF0dXMgPSByZXF1ZXN0KCktPmhhcygnc3RhdHVzJykgPyByZXF1ZXN0KCktPmdldCgnc3RhdHVzJykgOiAnJzsKCiAgICAgICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAgICAgJHRvID0gcmVxdWVzdCgpLT5oYXMoJ3RvJykgPyByZXF1ZXN0KCktPmdldCgndG8nKSA6IGRhdGUoJ1ktbS10Jyk7CiAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjYXRlZ29yeV9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2NhdGVnb3J5X2lkJykgOiAwOwoKICAgICAgICAgICAgJGNhdGVnb3J5SWRzID0gQ2F0ZWdvcnlEZXBhcnRtZW50Ojp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGNhdGVnb3J5SWRzKQogICAgICAgICAgICAgICAgLT5nZXQoWydpZCcsICduYW1lJywgJ2NvZGUnXSk7CgogICAgICAgICAgICAkZGVsaXZlcmVkUmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxSZXF1aXNpdGlvbicsCiAgICAgICAgICAgICAgICAncHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgICAgICAgICAncHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsIEF1dGg6OnVzZXIoKS0+aWQpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJGZyb20pID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkZnJvbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkZnJvbSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ2RlbGl2ZXJ5X2RhdGUnLCAnPj0nLCAkZnJvbSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkdG8pID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkdG8pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc8PScsICR0byk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVuKCFlbXB0eSgkc3RhdHVzKSwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N0YXR1cycsICRzdGF0dXMpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbigkY2F0ZWdvcnlfaWQgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uLml0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjYXRlZ29yeV9pZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlbighZW1wdHkocmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuIHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRkZWxpdmVyZWRSZXF1aXNpdGlvbikKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtc3JjPSInIC4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsICR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5pZCkgLiAnIiAgY2xhc3M9ImJ0biBidG4tbGluayByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InNob3dSZXF1aXN0aW9uRGV0YWlscygkKHRoaXMpKSI+JyAuIChpc3NldCgkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWxSZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vKSA/ICR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gOiAnJykgLiAnPC9hPjwvdGQ+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSA/IGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSkgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyZWRfcmVmX25vJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlZmVyZW5jZV9ubykgPyAkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWZlcmVuY2Vfbm8gOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkZWxpdmVyZWRfcmVmX25vJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5kZWxpdmVyeV9kYXRlKSA/IGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPmRlbGl2ZXJ5X2RhdGUpKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2NhdGVnb3J5JywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWUpID8gJHZhbHVlcy0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3ViX2NhdGVnb3J5JywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lKSA/ICR2YWx1ZXMtPnByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc3ViX2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3Byb2R1Y3QuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3QnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHZhbHVlcy0+cHJvZHVjdC0+bmFtZSkgPyAkdmFsdWVzLT5wcm9kdWN0LT5uYW1lIDogJycgLiAoaXNzZXQoJHZhbHVlcy0+cHJvZHVjdC0+aWQpID8gZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHZhbHVlcy0+cHJvZHVjdCkgOiAnJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncHJvZHVjdCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdwcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignZGVsaXZlcnlfcXR5JywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bWJlcl9mb3JtYXQoJHZhbHVlcy0+ZGVsaXZlcnlfcXR5LCAwKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnPHAgaWQ9ImFjdGlvbicgLiAkdmFsdWVzLT5pZCAuICciPic7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5zdGF0dXMgPT0gJ3BlbmRpbmcnIHx8ICR2YWx1ZXMtPnN0YXR1cyA9PSAnZGVsaXZlcmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gZHJvcGRvd24tdG9nZ2xlIiBkYXRhLXRvZ2dsZT0iZHJvcGRvd24iPgogICAgICAgICAgICAgICAgPHNwYW4gaWQ9InN0YXR1c05hbWUnIC4gJHZhbHVlcy0+aWQgLiAnIj4KICAgICAgICAgICAgICAgICcgLiB1Y2ZpcnN0KCR2YWx1ZXMtPnN0YXR1cykgLiAnIAogICAgICAgICAgICAgICAgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0iYmkgYmktdGhyZWUtZG90cy12ZXJ0aWNhbCIgdmlld0JveD0iMCAwIDE2IDE2Ij4KICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik05LjUgMTNhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAweiIvPgogICAgICAgICAgICAgICAgPC9zdmc+CiAgICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+PGxpIGlkPSJoaWRlQnRuJyAuICR2YWx1ZXMtPmlkIC4gJyI+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJkZWxpdmVyZWRBY2tub3dsZWRnZSgkKHRoaXMpKSIgY2xhc3M9ImRlbGl2ZXJlZEFja25vd2xlZGdlIiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiB0aXRsZT0iQWNrbm93bGVkZ2VkIj48aSBjbGFzcz0ibGEgbGEtY2hlY2siPjwvaT5BY2tub3dsZWRnZWQ8L2E+CiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgICAgIDwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnQWNrbm93bGVkZ2VkJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywgJ3Byb2R1Y3QnLCAnYWN0aW9ucyddKQogICAgICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdEZWxpdmVyZCBSZXF1aXNpdGlvbicsCiAgICAgICAgICAgICAgICAnZnJvbScgPT4gJGZyb20sCiAgICAgICAgICAgICAgICAndG8nID0+ICR0bywKICAgICAgICAgICAgICAgICdzdGF0dXNzJyA9PiBbJ3BlbmRpbmcnLCAnYWNrbm93bGVkZ2UnLCAnZGVsaXZlcmVkJ10sCiAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+ICRjYXRlZ29yeV9pZCwKICAgICAgICAgICAgICAgICdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+ZEhlYWRlckNvbHVtbnMoKSwKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbi1kZWxpdmVyeS5kZWxpdmVyZWQtcmVxdWlzaXRpb24tbGlzdCcsICRkYXRhKTsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZGVsaXZlcmVkUmVxdWlzaXRpb25BY2soUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKCiAgICAgICAgJHJlc3BvbnNlID0gW107CgogICAgICAgICRkZWxpdmVyZWRSZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOjp3aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uLnJlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxSZXF1aXNpdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsIEF1dGg6OnVzZXIoKS0+aWQpOwogICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywgJHJlcXVlc3QtPmlkKQogICAgICAgICAgICAtPmZpcnN0KCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChpc3NldCgkZGVsaXZlcmVkUmVxdWlzaXRpb24pKSB7CgogICAgICAgICAgICAgICAgJGRlbGl2ZXJlZFJlcXVpc2l0aW9uLT5zdGF0dXMgPSAnYWNrbm93bGVkZ2UnOwogICAgICAgICAgICAgICAgJGRlbGl2ZXJlZFJlcXVpc2l0aW9uLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ1N1Y2Nlc3NmdWxseSBBY2tub3dsZWRnZWQuJzsKCiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJGRlbGl2ZXJlZFJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWxSZXF1aXNpdGlvbi0+aWQsICdyZWNlaXZlZCcpOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnTm8gRGF0YSBGb3VuZCc7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewoKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJlc3BvbnNlOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZWxpdmVyZWRSZXF1aXNpdGlvblNlYXJjaChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXNwb25zZSA9IFtdOwoKICAgICAgICAkZnJvbURhdGUgPSBkYXRlKCdZLW0tZCBIOmk6cycsIHN0cnRvdGltZSgkcmVxdWVzdC0+ZnJvbV9kYXRlKSk7CiAgICAgICAgJHRvRGF0ZSA9IGRhdGUoJ1ktbS1kIEg6aTpzJywgc3RydG90aW1lKCRyZXF1ZXN0LT50b19kYXRlKSk7CgogICAgICAgICRzdGF0dXMgPSAkcmVxdWVzdC0+c3RhdHVzOwoKICAgICAgICAkZGVsaXZlcmVkUmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxSZXF1aXNpdGlvbi5yZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhdXRob3JfaWQnLCBBdXRoOjp1c2VyKCktPmlkKTsKICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJHN0YXR1cywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkc3RhdHVzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJHN0YXR1cyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkZnJvbURhdGUsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGZyb21EYXRlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGZyb21EYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdkZWxpdmVyeV9kYXRlJywgJz49JywgJGZyb21EYXRlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJHRvRGF0ZSwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkdG9EYXRlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJHRvRGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc8PScsICR0b0RhdGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+b3JkZXJCeSgnaWQnLCAnREVTQycpCiAgICAgICAgICAgIC0+cGFnaW5hdGUoMzApOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY291bnQoJGRlbGl2ZXJlZFJlcXVpc2l0aW9uKSA+IDApIHsKICAgICAgICAgICAgICAgICRib2R5ID0gVmlldzo6bWFrZSgncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb24tZGVsaXZlcnkuZGVsaXZlcmVkLXJlcXVpc2l0aW9uLXNlYXJjaCcsCiAgICAgICAgICAgICAgICAgICAgWydkZWxpdmVyZWRSZXF1aXNpdGlvbicgPT4gJGRlbGl2ZXJlZFJlcXVpc2l0aW9uXSk7CiAgICAgICAgICAgICAgICAkY29udGVudHMgPSAkYm9keS0+cmVuZGVyKCk7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydib2R5J10gPSAkY29udGVudHM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ05vIERhdGEgRm91bmQhISc7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewoKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGhpc3RvcnkoJGlkKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAiUmVxdWlzaXRpb24gSGlzdG9yeSI7CgogICAgICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbnM6OndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRpZCktPmZpcnN0KCk7CgogICAgICAgICAgICBpZiAoJHJlcXVpc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAkcHJvcG9zYWxzID0gKCRyZXF1aXNpdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsKSA/ICRyZXF1aXNpdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsIDogJyc7CgogICAgICAgICAgICAgICAgaWYgKCRwcm9wb3NhbHMgJiYgY291bnQoJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucykgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgJHB1cmNoYXNlID0gJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucygpLT53aXRoKCdyZWxQdXJjaGFzZU9yZGVyJyktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXIgPSBpc3NldCgkcHVyY2hhc2UpID8gKCFlbXB0eSgkcHVyY2hhc2UtPnJlbFB1cmNoYXNlT3JkZXIpID8gJHB1cmNoYXNlLT5yZWxQdXJjaGFzZU9yZGVyIDogJycpIDogJyc7CgogICAgICAgICAgICAgICAgaWYgKCRwdXJjaGFzZU9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgJGJpbGxNYW5hZ2UgPSBQdXJjaGFzZU9yZGVyOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbEdvb2RSZWNlaXZlTm90ZScsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbVN0b2NrSW4nLAogICAgICAgICAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24uZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcycsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWxQb0F0dGFjaG1lbnQnCiAgICAgICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZSgnaXNfc2VuZCcsICd5ZXMnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxHb29kUmVjZWl2ZU5vdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlUmF3KCdwdXJjaGFzZV9vcmRlcnMuaWQ9Z29vZHNfcmVjZWl2ZWRfbm90ZXMucHVyY2hhc2Vfb3JkZXJfaWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luJywgZnVuY3Rpb24gKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX2dybl9jb21wbGV0ZScsICd5ZXMnKS0+d2hlcmUoJ3RvdGFsX2Ftb3VudCcsICc+JywgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywgJHB1cmNoYXNlT3JkZXItPmlkKQogICAgICAgICAgICAgICAgICAgICAgICAtPmZpcnN0KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRiaWxsTWFuYWdlID0gJyc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJmcC5yZnAtaGlzdG9yeScsIGNvbXBhY3QoJ3RpdGxlJywgJ3B1cmNoYXNlT3JkZXInLCAncHJvcG9zYWxzJywgJ2JpbGxNYW5hZ2UnKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndoZXJlKCdpZCcsICRpZCktPmZpcnN0KCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5oaXN0b3J5JywgY29tcGFjdCgndGl0bGUnLCAncmVxdWlzaXRpb24nKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc3RvcmVIZWFkZXJDb2x1bW5zKCR2YWx1ZSA9ICcnKQogICAgewogICAgICAgICRyb3cgPSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3VuaXQnLCAndW5pdCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2Nvc3RfY2VudHJlJywgJ2Nvc3RfY2VudHJlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9uX2RhdGUnLCAncmVxdWlzaXRpb25fZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2RlcGFydG1lbnQnLCAnZGVwYXJ0bWVudCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RfY2F0ZWdvcnknLCAncHJvZHVjdF9jYXRlZ29yeScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FwcHJvdmVkX2J5JywgJ2FwcHJvdmVkX2J5JywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ3NhbGVhYmxlJywgJ3NhbGVhYmxlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3RhdHVzJywgJ3N0YXR1cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlcicsICd3aWR0aDoxNSUnXQogICAgICAgICk7CiAgICAgICAgcmV0dXJuICRyb3c7CiAgICB9CgoKICAgIHB1YmxpYyBmdW5jdGlvbiBmaW5hbmNlQXBwcm92YWwoKQogICAgewogICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdnZXQtY29zdC1jZW50cmVzJykpewogICAgICAgICAgICByZXR1cm4gZ2V0Q29zdENlbnRyZXMoZmFsc2UsIHJlcXVlc3QoKS0+Z2V0KCdjb21wYW55X2lkJykpOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRpdGxlID0gJ1BlbmRpbmcgUmVxdWlzaXRpb24gQXBwcm92YWwgTGlzdCBWaWV3JzsKICAgICAgICAgICAgJHVzZXJVbml0cyA9IGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfdW5pdF9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgICAgICR1c2VyQ29zdENlbnRyZXMgPSBhdXRoKCktPnVzZXIoKS0+Y29zdENlbnRyZXMtPnBsdWNrKCdjb3N0X2NlbnRyZV9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkY29tcGFueV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjb21wYW55X2lkJykgPyByZXF1ZXN0KCktPmdldCgnY29tcGFueV9pZCcpIDogbnVsbDsKICAgICAgICAgICAgJGNvc3RfY2VudHJlX2lkID0gcmVxdWVzdCgpLT5oYXMoJ2Nvc3RfY2VudHJlX2lkJykgPyByZXF1ZXN0KCktPmdldCgnY29zdF9jZW50cmVfaWQnKSA6IG51bGw7CiAgICAgICAgICAgICRzdGF0dXMgPSByZXF1ZXN0KCktPmhhcygnc3RhdHVzJykgPyByZXF1ZXN0KCktPmdldCgnc3RhdHVzJykgOiAncGVuZGluZyc7CiAgICAgICAgICAgICR0eXBlID0gcmVxdWVzdCgpLT5oYXMoJ3R5cGUnKSA/IHJlcXVlc3QoKS0+Z2V0KCd0eXBlJykgOiAnc2luZ2xlJzsKICAgICAgICAgICAgJHN0YXR1cyA9IHJlcXVlc3QoKS0+aGFzKCdzdGF0dXMnKSA/IHJlcXVlc3QoKS0+Z2V0KCdzdGF0dXMnKSA6ICdwZW5kaW5nJzsKICAgICAgICAgICAgJGZyb20gPSByZXF1ZXN0KCktPmhhcygnZnJvbScpID8gcmVxdWVzdCgpLT5nZXQoJ2Zyb20nKSA6IG51bGw7CiAgICAgICAgICAgICR0byA9IHJlcXVlc3QoKS0+aGFzKCd0bycpID8gcmVxdWVzdCgpLT5nZXQoJ3RvJykgOiBudWxsOwoKICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb24tZmluYW5jZS1hcHByb3ZhbC1saXN0JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdyZXF1aXNpdGlvbi1maW5hbmNlLWFwcHJvdmFsLWxpc3QnKQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoCiAgICAgICAgICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1bml0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjb3N0Q2VudHJlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS51bml0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhcHByb3ZlZEJ5JwogICAgICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCR1c2VyVW5pdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2FzX3VuaXRfaWQnLCAkdXNlclVuaXRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVOb3RJbignc3RhdHVzJywgWzAsIDNdKQoKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVuKCRjb21wYW55X2lkID4gMCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNvbXBhbnlfaWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3VuaXQnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCRjb21wYW55X2lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2NvbXBhbnlfaWQnLCAkY29tcGFueV9pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlbigkY29zdF9jZW50cmVfaWQgPiAwLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkY29zdF9jZW50cmVfaWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2Nvc3RfY2VudHJlX2lkJywgJGNvc3RfY2VudHJlX2lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJGZyb20pID4gMCwgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgkZnJvbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJz49JywgJGZyb20pOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZW4oc3RydG90aW1lKCR0bykgPiAwLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UgKCR0bykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJzw9JywgJHRvKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVuKCRzdGF0dXMgPT0gJ3BlbmRpbmcnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkc3RhdHVzKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2ZpbmFuY2VfYXBwcm92YWwnLCBbJ3BlbmRpbmcnLCAncmVzZW50J10pOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZW4oJHN0YXR1cyAhPSAncGVuZGluZycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRzdGF0dXMpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX2ZpbmFuY2VfYXBwcm92YWwnLCAkc3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVuKCR0eXBlICE9PSAnYWxsJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc3NpZ25lZF9maW5hbmNlX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZShmdW5jdGlvbigkcXVlcnkpIHVzZSgkdXNlckNvc3RDZW50cmVzKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uKCRxdWVyeSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlTnVsbCgnY29zdF9jZW50cmVfaWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHVzZXJDb3N0Q2VudHJlcyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignY29zdF9jZW50cmVfaWQnLCAkdXNlckNvc3RDZW50cmVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uICgkcXVlcnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcgLiAkdmFsdWVzLT5pZCAuICcpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+JyAuICR2YWx1ZXMtPnJlZmVyZW5jZV9ubyAuICc8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5yZXF1aXNpdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncmVxdWlzaXRpb25fZGF0ZScsICRvcmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkdmFsdWVzLT51bml0LT5ocl91bml0X3Nob3J0X25hbWU7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCd1bml0JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnaHJfdW5pdF9zaG9ydF9uYW1lJywgJ0xJS0UnLCAnJScgLiAka2V5d29yZCAuICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigndW5pdCcsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBVbml0OjpzZWxlY3QoJ2hyX3VuaXQuaHJfdW5pdF9zaG9ydF9uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ2hyX3VuaXQuaHJfdW5pdF9pZCcsICdyZXF1aXNpdGlvbnMuaHJfdW5pdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignY29zdF9jZW50cmUnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHZhbHVlcy0+Y29zdENlbnRyZSA/ICR2YWx1ZXMtPmNvc3RDZW50cmUtPm5hbWUgOiAnJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdjb3N0X2NlbnRyZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdjb3N0Q2VudHJlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlICgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2Nvc3RfY2VudHJlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIENvc3RDZW50cmU6OnNlbGVjdCgnY29zdF9jZW50cmVzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignY29zdF9jZW50cmVzLmlkJywgJ3JlcXVpc2l0aW9ucy5jb3N0X2NlbnRyZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGVwYXJ0bWVudCcsIGZ1bmN0aW9uICgkdmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT5kZXBhcnRtZW50LT5ocl9kZXBhcnRtZW50X25hbWUpID8gJHZhbHVlcy0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+ZGVwYXJ0bWVudC0+aHJfZGVwYXJ0bWVudF9uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGVwYXJ0bWVudCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUuZGVwYXJ0bWVudCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfbmFtZScsICdMSUtFJywgJyUnIC4gJGtleXdvcmQgLiAnJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2RlcGFydG1lbnQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgVXNlcjo6c2VsZWN0KCdocl9kZXBhcnRtZW50LmhyX2RlcGFydG1lbnRfbmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2hyX2FzX2Jhc2ljX2luZm8nLCAnaHJfYXNfYmFzaWNfaW5mby5hc3NvY2lhdGVfaWQnLCAnPScsICd1c2Vycy5hc3NvY2lhdGVfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdocl9kZXBhcnRtZW50JywgJ2hyX2RlcGFydG1lbnQuaHJfZGVwYXJ0bWVudF9pZCcsICc9JywgJ2hyX2FzX2Jhc2ljX2luZm8uYXNfZGVwYXJ0bWVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCd1c2Vycy5pZCcsICdyZXF1aXNpdGlvbnMuYXV0aG9yX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKSA/ICRyZXF1aXNpdGlvbi0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSA6ICcnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVpc2l0aW9uSXRlbTo6c2VsZWN0KCdtYWluX2NhdGVnb3J5Lm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIHN1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnkuaWQnLCAnPScsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgbWFpbl9jYXRlZ29yeScsICdtYWluX2NhdGVnb3J5LmlkJywgJz0nLCAnc3ViX2NhdGVnb3J5LnBhcmVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXBwcm92ZWRfYnknLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHZhbHVlcy0+YXBwcm92ZWRCeS0+bmFtZSkgPyAkdmFsdWVzLT5hcHByb3ZlZEJ5LT5uYW1lIDogJyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignYXBwcm92ZWRfYnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnYXBwcm92ZWRCeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSAoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJyAuICRrZXl3b3JkIC4gJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhcHByb3ZlZF9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBVc2VyOjpzZWxlY3QoJ3VzZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigndXNlcnMuaWQnLCAncmVxdWlzaXRpb25zLmFwcHJvdmVkX2J5JykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbiAoJHZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdWN3b3JkcygkdmFsdWVzLT5pc19maW5hbmNlX2FwcHJvdmFsKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24gKCR2YWx1ZXMpIHVzZSAoJG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRvcHRpb25zWydyZXF1aXNpdGlvbi1maW5hbmNlLWFwcHJvdmFsLWxpc3QnXSAmJiAkdmFsdWVzLT5zdGF0dXMgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaW5fYXJyYXkoJHZhbHVlcy0+aXNfZmluYW5jZV9hcHByb3ZhbCwgWydwZW5kaW5nJywgJ3Jlc2VudCcsICdkZW5pZWQnXSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyBtYi0xIG1yLTEgdGV4dC13aGl0ZSBmaW5hbmNlQXBwcm92YWwiIG9uY2xpY2s9ImZpbmFuY2VBcHByb3ZhbCgkKHRoaXMpKSIgZGF0YS1zcmM9IicgLiByb3V0ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgnYWNjb3VudGluZy5yZXF1aXNpdGlvbi5maW5hbmNlLmFwcHJvdmFsLnN1Ym1pdCcpIC4gJyIgZGF0YS1pZD0iJyAuICR2YWx1ZXMtPmlkIC4gJyIgdGl0bGU9IkFwcHJvdmUiPjxpIGNsYXNzPSJsYXMgbGEtY2hlY2siPjwvaT4mbmJzcDtBcHByb3ZlPC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaW5fYXJyYXkoJHZhbHVlcy0+aXNfZmluYW5jZV9hcHByb3ZhbCwgWydwZW5kaW5nJywgJ3Jlc2VudCddKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1kYW5nZXIgbWItMSB0ZXh0LXdoaXRlIGZpbmFuY2VEZW5pZWwiIG9uY2xpY2s9ImZpbmFuY2VEZW5pZWwoJCh0aGlzKSkiIGRhdGEtc3JjPSInIC4gcm91dGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoJ2FjY291bnRpbmcucmVxdWlzaXRpb24uZmluYW5jZS5kZW5pZWwuc3VibWl0JykgLiAnIiBkYXRhLWlkPSInIC4gJHZhbHVlcy0+aWQgLiAnIiB0aXRsZT0iRGVueSI+PGkgY2xhc3M9ImxhcyBsYS1iYW4iPjwvaT4mbmJzcDtEZW55PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlZmVyZW5jZV9ubycsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb24uZmluYW5jZS1hcHByb3ZhbC1saXN0JywgWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAnY29tcGFuaWVzJyA9PiBDb21wYW55OjpoYXMoJ3Byb2ZpdENlbnRyZXMuY29zdENlbnRyZXMnKQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygndXNlcnMnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCd1c2VyX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmdldCgpLAogICAgICAgICAgICAgICAgJ2NvbXBhbnlfaWQnID0+ICRjb21wYW55X2lkLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJHN0YXR1cywKICAgICAgICAgICAgICAgICdmcm9tJyA9PiAkZnJvbSwKICAgICAgICAgICAgICAgICd0bycgPT4gJHRvLAogICAgICAgICAgICAgICAgJ3R5cGUnID0+ICR0eXBlLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5zdG9yZUhlYWRlckNvbHVtbnMoKSwKICAgICAgICAgICAgXSk7CgogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzdG9yZUludmVudG9yeUNvbXBhcmUoJGlkKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0aXRsZSA9ICdTdG9yZSBJbnZlbnRvcnkgQ29tcGFyZSc7CgogICAgICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6d2l0aChbCiAgICAgICAgICAgICAgICAndW5pdCcsCiAgICAgICAgICAgICAgICAncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxEZWxpdmVyeUl0ZW1zJywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LnJlbEludmVudG9yeURldGFpbHMnLAogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QucHJvZHVjdFVuaXQnLAogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICdpdGVtcy5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS51bml0JywKICAgICAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUuZGVwYXJ0bWVudCcsCiAgICAgICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlLmxvY2F0aW9uJywKICAgICAgICAgICAgICAgICdwcm9qZWN0VGFzay5zdWJEZWxpdmVyYWJsZS5kZWxpdmVyYWJsZS5wcm9qZWN0JwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPmZpbmRPckZhaWwoJGlkKTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvblsncmVxdWlzaXRpb25fcXR5J10gPSAkcmVxdWlzaXRpb24tPml0ZW1zLT5zdW0oJ3F0eScpOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5lYWNoKGZ1bmN0aW9uICgkaXRlbSwgJGkpIHsKICAgICAgICAgICAgICAgICRpdGVtWydkZWxpdmVyeV9xdHknXSA9ICRpdGVtLT5yZWxEZWxpdmVyeUl0ZW1zLT5zdW0oJ2RlbGl2ZXJ5X3F0eScpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uWyd0b3RhbF9kZWxpdmVyeV9xdHknXSA9ICRyZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+c3VtKCdkZWxpdmVyeV9xdHknKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbi5zaG93JywgY29tcGFjdCgndGl0bGUnLCAncmVxdWlzaXRpb24nKSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGZpbmFuY2VBcHByb3ZhbFN1Ym1pdChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndoZXJlKFsKICAgICAgICAgICAgICAgICdpZCcgPT4gJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gMSwKICAgICAgICAgICAgICAgICdhcHByb3ZlZF9pZCcgPT4gMSwKICAgICAgICAgICAgICAgICdpc19zZW5kX3RvX3JmcCcgPT4gJ25vJywKICAgICAgICAgICAgICAgICdkZWxpdmVyeV9zdGF0dXMnID0+ICdwcm9jZXNzaW5nJywKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUluKCdpc19maW5hbmNlX2FwcHJvdmFsJywgWydwZW5kaW5nJywgJ3Jlc2VudCddKQogICAgICAgICAgICAtPmZpcnN0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkcmVxdWlzaXRpb24tPmlzX2ZpbmFuY2VfYXBwcm92YWwgPSAnYXBwcm92ZWQnOwogICAgICAgICAgICAkcmVxdWlzaXRpb24tPmFwcHJvdmVyX2RhdGUgPSBub3coKTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5zYXZlKCk7CgogICAgICAgICAgICByZXF1aXNpdGlvblRyYWNraW5nSGlzdG9yeSgkcmVxdWlzaXRpb24tPmlkLCdhcHByb3ZlZF9ieV9maW5hbmNlJywnRmluYW5jZSBBcHByb3ZlZCBhbmQgU2VuZCB0byBTdG9yZScpOwoKICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9IicgLiBnZXRNb2R1bGVzKClbJ3BtcyddLT51cmwgLiAnL3Btcy9zdG9yZS1tYW5hZ2Uvc3RvcmUtaW52ZW50b3J5LWNvbXBhcmUvJyAuICRyZXF1aXNpdGlvbi0+aWQgLiAnIiBkYXRhLXRpdGxlPSJSZXF1aXNpdGlvbiBEZXRhaWxzIj5SZWZlcmVuY2UgTm86JyAuICRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vIC4gJy5XYWl0aW5nIGZvciBQcm9jdXJlbWVudC9EZWxpdmVyeS48L3NwYW4+JzsKICAgICAgICAgICAgCiAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCRtZXNzYWdlLCAndW5yZWFkJywgJycsIGdldE1hbmFnZXJJbmZvKCdTdG9yZS1NYW5hZ2VyJywgJHJlcXVpc2l0aW9uLT5ocl91bml0X2lkKSwgJ3NlbmQtdG8tc3RvcmUnLCAnJyk7CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdTdWNjZXNzZnVsbHkgU2VuZCB0byBTdG9yZSBEZXBhcnRtZW50LicKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGZpbmFuY2VEZW5pZWxTdWJtaXQoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aGVyZShbCiAgICAgICAgICAgICAgICAnaWQnID0+ICRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZCwKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+IDEsCiAgICAgICAgICAgICAgICAnYXBwcm92ZWRfaWQnID0+IDEsCiAgICAgICAgICAgICAgICAnaXNfc2VuZF90b19yZnAnID0+ICdubycsCiAgICAgICAgICAgICAgICAnZGVsaXZlcnlfc3RhdHVzJyA9PiAncHJvY2Vzc2luZycsCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVJbignaXNfZmluYW5jZV9hcHByb3ZhbCcsIFsncGVuZGluZycsICdyZXNlbnQnXSkKICAgICAgICAgICAgLT5maXJzdCgpOwogICAgICAgICAgICAkcmVxdWlzaXRpb24tPmlzX2ZpbmFuY2VfYXBwcm92YWwgPSAnZGVuaWVkJzsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5maW5hbmNlX2NvbW1lbnRzID0gJHJlcXVlc3QtPmNvbW1lbnRzOwogICAgICAgICAgICAkcmVxdWlzaXRpb24tPnNhdmUoKTsKCiAgICAgICAgICAgIHJlcXVpc2l0aW9uVHJhY2tpbmdIaXN0b3J5KCRyZXF1aXNpdGlvbi0+aWQsJ2RlbmllZF9ieV9maW5hbmNlJywnRmluYW5jZSBEZW5pZWQgYW5kIFJlcXVpc2l0aW9uIEhhbHQnKTsKCgogICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJyAuIGdldE1vZHVsZXMoKVsncG1zJ10tPnVybCAuICcvcG1zL3N0b3JlLW1hbmFnZS9zdG9yZS1pbnZlbnRvcnktY29tcGFyZS8nIC4gJHJlcXVpc2l0aW9uLT5pZCAuICciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonIC4gJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLiAnLldhaXRpbmcgZm9yIFByb2N1cmVtZW50L0RlbGl2ZXJ5Ljwvc3Bhbj4nOwogICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbigkbWVzc2FnZSwgJ3VucmVhZCcsICcnLCBnZXRNYW5hZ2VySW5mbygnU3RvcmUtTWFuYWdlcicsICRyZXF1aXNpdGlvbi0+aHJfdW5pdF9pZCksICdzZW5kLXRvLXN0b3JlJywgJycpOwoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUmVxdWlzaXRpb24gaGFzIGJlZW4gRGVuaWVkLiIKICAgICAgICAgICAgXSk7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9Cn0KCg==